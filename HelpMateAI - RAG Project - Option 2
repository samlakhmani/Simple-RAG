{"cells":[{"cell_type":"markdown","metadata":{"id":"ghrNO9TjM_mS"},"source":["##Install and Import the Required Libraries"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"8PsPVtxoSY_V"},"outputs":[],"source":["# Install all the required libraries\n","\n","!pip install -U -q pdfplumber tiktoken openai chromaDB sentence-transformers --quiet"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"R7uDlZS0M99u"},"outputs":[],"source":["# Import all the required Libraries\n","\n","import pdfplumber\n","from pathlib import Path\n","import pandas as pd\n","from operator import itemgetter\n","import json\n","import tiktoken\n","import openai\n","import chromadb"]},{"cell_type":"code","source":["import warnings\n","warnings.filterwarnings('ignore')"],"metadata":{"id":"Ejj1N5HkPmFp"},"execution_count":null,"outputs":[]},{"cell_type":"code","execution_count":null,"metadata":{"id":"xl87i2pdQUIq","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1718613684059,"user_tz":-330,"elapsed":4446,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"d95c7573-7ea2-435e-a07b-c432ba74eef2"},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}],"source":["# Mount Google Drive\n","from google.colab import drive\n","drive.mount('/content/drive', force_remount=True)"]},{"cell_type":"code","source":["class color:\n","   PURPLE = '\\033[95m'\n","   CYAN = '\\033[96m'\n","   DARKCYAN = '\\033[36m'\n","   BLUE = '\\033[94m'\n","   GREEN = '\\033[92m'\n","   YELLOW = '\\033[93m'\n","   RED = '\\033[91m'\n","   BOLD = '\\033[1m'\n","   UNDERLINE = '\\033[4m'\n","   END = '\\033[0m'"],"metadata":{"id":"CC--EkWsU1Al"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"l-CoovqcqgkM"},"source":["## <font color = magenta> 1. Layer 1 : Embedding Layer"]},{"cell_type":"markdown","source":["### 1.1 Read, Process, and Chunk the PDF Files"],"metadata":{"id":"TvzJdaWI4rg3"}},{"cell_type":"code","execution_count":null,"metadata":{"id":"iw_75A_zQiU_"},"outputs":[],"source":["pdf_path = '/content/drive/MyDrive/upgrad/Course 3 - RAG'"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"yaRqBDikEi-e"},"outputs":[],"source":["def check_bboxes(word, table_bbox):\n","    # Check whether word is inside a table bbox.\n","    l = word['x0'], word['top'], word['x1'], word['bottom']\n","    r = table_bbox\n","    return l[0] > r[0] and l[1] > r[1] and l[2] < r[2] and l[3] < r[3]"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"5vl3fNNvDyBG"},"outputs":[],"source":["def extract_text_from_pdf(pdf_path):\n","    p = 0\n","    full_text = []\n","\n","\n","    with pdfplumber.open(pdf_path) as pdf:\n","        for page in pdf.pages:\n","            page_no = f\"Page {p+1}\"\n","            text = page.extract_text()\n","\n","            tables = page.find_tables()\n","            table_bboxes = [i.bbox for i in tables]\n","            tables = [{'table': i.extract(), 'top': i.bbox[1]} for i in tables]\n","            non_table_words = [word for word in page.extract_words() if not any(\n","                [check_bboxes(word, table_bbox) for table_bbox in table_bboxes])]\n","            lines = []\n","\n","            for cluster in pdfplumber.utils.cluster_objects(non_table_words + tables, itemgetter('top'), tolerance=5):\n","\n","                if 'text' in cluster[0]:\n","                    try:\n","                        lines.append(' '.join([i['text'] for i in cluster]))\n","                    except KeyError:\n","                        pass\n","\n","                elif 'table' in cluster[0]:\n","                    lines.append(json.dumps(cluster[0]['table']))\n","\n","\n","            full_text.append([page_no, \" \".join(lines)])\n","            p +=1\n","\n","    return full_text"]},{"cell_type":"markdown","metadata":{"id":"JIBPOBOxefd0"},"source":["*Now that we have defined the function for extracting the text and tables from a PDF, let's iterate and call this function for all the PDFs in our drive and store them in a list.*"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"gi8dV-BN6U7A","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1718613701517,"user_tz":-330,"elapsed":17466,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"a2a9d96d-3c99-44b1-b053-6b8c8349490e"},"outputs":[{"output_type":"stream","name":"stdout","text":["...Processing Principal-Sample-Life-Insurance-Policy.pdf\n","Finished processing Principal-Sample-Life-Insurance-Policy.pdf\n","All PDFs have been processed.\n"]}],"source":["# Define the directory containing the PDF files\n","pdf_directory = Path(pdf_path)\n","\n","# Initialize an empty list to store the extracted texts and document names\n","data = []\n","\n","# Loop through all files in the directory\n","for pdf_path in pdf_directory.glob(\"*.pdf\"):\n","\n","    # Process the PDF file\n","    print(f\"...Processing {pdf_path.name}\")\n","\n","    # Call the function to extract the text from the PDF\n","    extracted_text = extract_text_from_pdf(pdf_path)\n","\n","    # Convert the extracted list to a PDF, and add a column to store document names\n","    extracted_text_df = pd.DataFrame(extracted_text, columns=['Page No.', 'Page_Text'])\n","    extracted_text_df['Document Name'] = pdf_path.name\n","\n","    # Append the extracted text and document name to the list\n","    data.append(extracted_text_df)\n","\n","    # Print a message to indicate progress\n","    print(f\"Finished processing {pdf_path.name}\")\n","\n","# Print a message to indicate all PDFs have been processed\n","print(\"All PDFs have been processed.\")"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"xDlL7PADDrrk"},"outputs":[],"source":["# Concatenate all the DFs in the list 'data' together\n","insurance_pdfs_data = pd.concat(data, ignore_index=True)\n","\n","# All the text are in upper case - lets convert them to lower case\n","insurance_pdfs_data.Page_Text = insurance_pdfs_data.Page_Text.str.lower()\n","\n","# Drop the duplicate rows\n","insurance_pdfs_data.Page_Text = insurance_pdfs_data.Page_Text.apply(lambda x: x.replace('page',''))\n","\n","# Let's also check the length of all the texts as there might be some empty pages or pages with very few words that we can drop\n","insurance_pdfs_data['Text_Length'] = insurance_pdfs_data['Page_Text'].apply(lambda x: len(x.split(' ')))\n","\n","# Retain only the rows with a text length of at least 10\n","insurance_pdfs_data = insurance_pdfs_data.loc[insurance_pdfs_data['Text_Length'] >= 10]\n","\n","# Store the metadata for each page in a separate column\n","insurance_pdfs_data['Metadata'] = insurance_pdfs_data.apply(lambda x: {'Policy_Name': x['Document Name'][:-4], 'Page_No.': x['Page No.'].split(' ')[1]}, axis=1)"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":112},"executionInfo":{"elapsed":6,"status":"ok","timestamp":1718613701517,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"},"user_tz":-330},"id":"2UTsH2QuQmpW","outputId":"76291a35-be39-44ca-993b-911df8dfbb4e"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["  Page No.                                          Page_Text  \\\n","0   Page 1  dorothea glause s655 rhode island john doe 01/...   \n","2   Page 3  policy rider group insurance policy no: s655 c...   \n","\n","                                Document Name  Text_Length  \\\n","0  Principal-Sample-Life-Insurance-Policy.pdf           30   \n","2  Principal-Sample-Life-Insurance-Policy.pdf          230   \n","\n","                                            Metadata  \n","0  {'Policy_Name': 'Principal-Sample-Life-Insuran...  \n","2  {'Policy_Name': 'Principal-Sample-Life-Insuran...  "],"text/html":["\n","  <div id=\"df-45e85324-aeb2-4abf-a8b2-ec30e9b15da5\" class=\"colab-df-container\">\n","    <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Page No.</th>\n","      <th>Page_Text</th>\n","      <th>Document Name</th>\n","      <th>Text_Length</th>\n","      <th>Metadata</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>Page 1</td>\n","      <td>dorothea glause s655 rhode island john doe 01/...</td>\n","      <td>Principal-Sample-Life-Insurance-Policy.pdf</td>\n","      <td>30</td>\n","      <td>{'Policy_Name': 'Principal-Sample-Life-Insuran...</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>Page 3</td>\n","      <td>policy rider group insurance policy no: s655 c...</td>\n","      <td>Principal-Sample-Life-Insurance-Policy.pdf</td>\n","      <td>230</td>\n","      <td>{'Policy_Name': 'Principal-Sample-Life-Insuran...</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","    <div class=\"colab-df-buttons\">\n","\n","  <div class=\"colab-df-container\">\n","    <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-45e85324-aeb2-4abf-a8b2-ec30e9b15da5')\"\n","            title=\"Convert this dataframe to an interactive table.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\" viewBox=\"0 -960 960 960\">\n","    <path d=\"M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z\"/>\n","  </svg>\n","    </button>\n","\n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    .colab-df-buttons div {\n","      margin-bottom: 4px;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","    <script>\n","      const buttonEl =\n","        document.querySelector('#df-45e85324-aeb2-4abf-a8b2-ec30e9b15da5 button.colab-df-convert');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      async function convertToInteractive(key) {\n","        const element = document.querySelector('#df-45e85324-aeb2-4abf-a8b2-ec30e9b15da5');\n","        const dataTable =\n","          await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                    [key], {});\n","        if (!dataTable) return;\n","\n","        const docLinkHtml = 'Like what you see? Visit the ' +\n","          '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","          + ' to learn more about interactive tables.';\n","        element.innerHTML = '';\n","        dataTable['output_type'] = 'display_data';\n","        await google.colab.output.renderOutput(dataTable, element);\n","        const docLink = document.createElement('div');\n","        docLink.innerHTML = docLinkHtml;\n","        element.appendChild(docLink);\n","      }\n","    </script>\n","  </div>\n","\n","\n","<div id=\"df-fb3ea27f-47a1-460b-ba92-6fa0737995cf\">\n","  <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-fb3ea27f-47a1-460b-ba92-6fa0737995cf')\"\n","            title=\"Suggest charts\"\n","            style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","  </button>\n","\n","<style>\n","  .colab-df-quickchart {\n","      --bg-color: #E8F0FE;\n","      --fill-color: #1967D2;\n","      --hover-bg-color: #E2EBFA;\n","      --hover-fill-color: #174EA6;\n","      --disabled-fill-color: #AAA;\n","      --disabled-bg-color: #DDD;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","      --bg-color: #3B4455;\n","      --fill-color: #D2E3FC;\n","      --hover-bg-color: #434B5C;\n","      --hover-fill-color: #FFFFFF;\n","      --disabled-bg-color: #3B4455;\n","      --disabled-fill-color: #666;\n","  }\n","\n","  .colab-df-quickchart {\n","    background-color: var(--bg-color);\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: var(--fill-color);\n","    height: 32px;\n","    padding: 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: var(--hover-bg-color);\n","    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: var(--button-hover-fill-color);\n","  }\n","\n","  .colab-df-quickchart-complete:disabled,\n","  .colab-df-quickchart-complete:disabled:hover {\n","    background-color: var(--disabled-bg-color);\n","    fill: var(--disabled-fill-color);\n","    box-shadow: none;\n","  }\n","\n","  .colab-df-spinner {\n","    border: 2px solid var(--fill-color);\n","    border-color: transparent;\n","    border-bottom-color: var(--fill-color);\n","    animation:\n","      spin 1s steps(1) infinite;\n","  }\n","\n","  @keyframes spin {\n","    0% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","      border-left-color: var(--fill-color);\n","    }\n","    20% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    30% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","      border-right-color: var(--fill-color);\n","    }\n","    40% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    60% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","    }\n","    80% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-bottom-color: var(--fill-color);\n","    }\n","    90% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","    }\n","  }\n","</style>\n","\n","  <script>\n","    async function quickchart(key) {\n","      const quickchartButtonEl =\n","        document.querySelector('#' + key + ' button');\n","      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.\n","      quickchartButtonEl.classList.add('colab-df-spinner');\n","      try {\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      } catch (error) {\n","        console.error('Error during call to suggestCharts:', error);\n","      }\n","      quickchartButtonEl.classList.remove('colab-df-spinner');\n","      quickchartButtonEl.classList.add('colab-df-quickchart-complete');\n","    }\n","    (() => {\n","      let quickchartButtonEl =\n","        document.querySelector('#df-fb3ea27f-47a1-460b-ba92-6fa0737995cf button');\n","      quickchartButtonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","    })();\n","  </script>\n","</div>\n","\n","    </div>\n","  </div>\n"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"dataframe","variable_name":"insurance_pdfs_data","summary":"{\n  \"name\": \"insurance_pdfs_data\",\n  \"rows\": 60,\n  \"fields\": [\n    {\n      \"column\": \"Page No.\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 60,\n        \"samples\": [\n          \"Page 1\",\n          \"Page 8\",\n          \"Page 39\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Page_Text\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 60,\n        \"samples\": [\n          \"dorothea glause s655 rhode island john doe 01/01/2014 711 high street george ri 02903 group policy for: rhode island john doe all members group member life insurance print date: 07/16/2014\",\n          \"section a - member life insurance schedule of insurance article 1 death benefits payable article 2 beneficiary article 3 facility of payment article 4 settlement of proceeds article 5 member life insurance - coverage during disability article 6 accelerated benefits article 7 section b - member accidental death and dismemberment insurance schedule of insurance article 1 benefit qualification article 2 benefits payable article 3 seat belt benefit article 4 loss of use or paralysis benefit article 5 loss of speech and/or hearing benefit article 6 repatriation benefit article 7 educational benefit article 8 limitations article 9 section c - dependent life insurance schedule of insurance article 1 death benefits payable article 2 beneficiary article 3 section d - claim procedures notice of claim article 1 claim forms article 2 proof of loss article 3 payment, denial and review article 4 medical examinations article 5 autopsy article 6 legal action article 7 time limits article 8 this policy has been updated effective january 1, 2014 gc 6001 table of contents,  3\",\n          \"(1) the child is incapable of self-support as the result of a developmental disability or physical handicap and became so before reaching the maximum age and is dependent on the member for primary support; and (2) except for age, the child continues to be a dependent child as defined in part i; and (3) proof of the child's incapacity is sent to the principal within 31 days after the date the child reaches the maximum age; and (4) further proof that the child remains incapable of self-support is provided when the principal requests; and (5) the child undergoes examination by a physician when the principal requests. the principal will pay for these examinations and will choose the physician to perform them. b. period of continuation insurance for a dependent child who qualifies as set forth above may be continued until the earlier of: (1) the date insurance would cease for any reason other than the child's attainment of the maximum age; or (2) the date the child becomes capable of self-support or otherwise fails to qualify as set forth in a. above. this policy has been updated effective january 1, 2014 part iii - individual requirements and rights gc 6009 section d - continuation,  2\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Document Name\",\n      \"properties\": {\n        \"dtype\": \"category\",\n        \"num_unique_values\": 1,\n        \"samples\": [\n          \"Principal-Sample-Life-Insurance-Policy.pdf\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Text_Length\",\n      \"properties\": {\n        \"dtype\": \"number\",\n        \"std\": 109,\n        \"min\": 30,\n        \"max\": 462,\n        \"num_unique_values\": 58,\n        \"samples\": [\n          30\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Metadata\",\n      \"properties\": {\n        \"dtype\": \"object\",\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    }\n  ]\n}"}},"metadata":{},"execution_count":11}],"source":["insurance_pdfs_data.head(2)"]},{"cell_type":"code","source":["insurance_pdfs_data.Page_Text[18]"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":87},"id":"vy_ybLVCyP9T","executionInfo":{"status":"ok","timestamp":1718613701517,"user_tz":-330,"elapsed":5,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"29c7e488-6e26-41df-ee28-83854ff646a2"},"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["'t he principal has complete discretion to construe or interpret the provisions of this group insurance policy, to determine eligibility for benefits, and to determine the type and extent of benefits, if any, to be provided. the decisions of the principal in such matters shall be controlling, binding and final as between the principal and persons covered by this group policy, subject to the claims procedures in part iv, section d. article 11 - electronic transactions any transaction relating to this group policy may be conducted by electronic means if performance of the transaction is consistent with applicable state and federal law. any notice required by the provisions of this group policy given by electronic means will have the same force and effect as notice given in writing. this policy has been updated effective january 1, 2014 part ii - policy administration gc 6003 section a - contract,  4'"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"string"}},"metadata":{},"execution_count":12}]},{"cell_type":"markdown","source":["### 1.2 Generate and Store Embeddings using OpenAI and ChromaDB"],"metadata":{"id":"spfTdDLG4-Py"}},{"cell_type":"code","execution_count":null,"metadata":{"id":"77AYVNHyW1-d"},"outputs":[],"source":["# Import the OpenAI Embedding Function into chroma\n","import chromadb\n","from chromadb.utils.embedding_functions import OpenAIEmbeddingFunction\n","\n","with open(\"/content/drive/MyDrive/upgrad/api_keys/OpenAI_key.txt\", \"r\") as f:\n","  openai.api_key = ' '.join(f.readlines())\n","\n","# Define the path where chroma collections will be stored\n","chroma_data_path = '/content/drive/MyDrive/upgrad/Course 3 - RAG/chroma'\n","\n","# Call PersistentClient()\n","client = chromadb.PersistentClient(chroma_data_path)\n","\n","# Set up the embedding function using the OpenAI embedding model\n","embedding_function = OpenAIEmbeddingFunction(\n","    api_key=openai.api_key,\n","    model_name=\"text-embedding-ada-002\"\n","  )\n","\n","# Initialise a collection in chroma and pass the embedding_function to it so that it used OpenAI embeddings to embed the documents\n","insurance_collection = client.get_or_create_collection(\n","    name='RAG_on_Insurance',\n","    embedding_function=embedding_function\n","  )\n","\n","cache_collection = client.get_or_create_collection(\n","    name='Insurance_Cache',\n","    embedding_function=embedding_function\n","  )"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"_d_jop5hcaQI"},"outputs":[],"source":["# Convert the page text and metadata from your dataframe to lists to be able to pass it to chroma\n","documents_list = insurance_pdfs_data[\"Page_Text\"].tolist()\n","metadata_list = insurance_pdfs_data['Metadata'].tolist()\n","\n","# Add the documents and metadata to the collection alongwith generic integer IDs. You can also feed the metadata information as IDs by combining the policy name and page no.\n","insurance_collection.upsert(\n","    documents= documents_list,\n","    ids = [str(i) for i in range(0, len(documents_list))],\n","    metadatas = metadata_list\n",")\n","\n","# Add the documents and metadata to the collection alongwith generic integer IDs. You can also feed the metadata information as IDs by combining the policy name and page no.\n","# insurance_collection.add(\n","#     documents= documents_list,\n","#     ids = [str(i) for i in range(0, len(documents_list))],\n","#     metadatas = metadata_list\n","# )"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":11,"status":"ok","timestamp":1718613703297,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"},"user_tz":-330},"id":"92Nr0XTVykX-","outputId":"13db7af3-7640-478f-8595-81ebcb939c41"},"outputs":[{"output_type":"stream","name":"stdout","text":["Embedding Length : 1536\n","Sample Embedding : [-0.03006616421043873, 0.02232346124947071, -0.026021866127848625, -0.033365458250045776, -0.005730531178414822]...\n","MetaData         : {'Page_No.': '1', 'Policy_Name': 'Principal-Sample-Life-Insurance-Policy'}\n","Page Text        : dorothea glause s655 rhode island john doe 01/01/2014 711 high street george ri 02903 group policy for: rhode island john doe all members group member life insurance print date: 07/16/2014\n"]}],"source":["# Let's take a look at the first few entries in the collection\n","check = insurance_collection.get(\n","    ids = ['0'],\n","    include = ['embeddings', 'documents', 'metadatas']\n",")\n","\n","print(f\"Embedding Length : {len((check['embeddings'][0]))}\")\n","print(f\"Sample Embedding : {(check['embeddings'][0][:5])}...\")\n","print(f\"MetaData         : {(check['metadatas'][0])}\")\n","print(f\"Page Text        : {(check['documents'][0])}\")"]},{"cell_type":"markdown","source":["## <font color = green> 2. Layer 2 : Retrival Layer"],"metadata":{"id":"ZBZvnw386IV3"}},{"cell_type":"markdown","metadata":{"id":"VSPM3aJ7lZd2"},"source":["### 2.2 Semantic Search with Cache\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"7w_JdePjjNoA"},"outputs":[],"source":["def search_db_with_cache(\n","    query,\n","    collection = insurance_collection,\n","    n_results = 10,\n","    cache_collection = None,\n","    cache_threshold = 0.2):\n","\n","\n","    # Set a threshold for cache search\n","    threshold = cache_threshold\n","\n","    cache_results = None\n","\n","    if cache_collection :\n","\n","      # Searh the Cache collection first\n","      cache_results = cache_collection.query(\n","          query_texts=query,\n","          n_results=1\n","      )\n","\n","\n","    if cache_results['distances'][0] == [] or cache_results['distances'][0][0] > threshold:\n","          # Query the collection against the user query and return the top 10 results\n","          results = insurance_collection.query(\n","          query_texts=query,\n","          n_results=n_results\n","          )\n","\n","          Keys = []\n","          Values = []\n","\n","          for key, val in results.items():\n","            if val is None:\n","              continue\n","            for i in range(10):\n","              Keys.append(str(key)+str(i))\n","              Values.append(str(val[0][i]))\n","\n","          cache_collection.add(\n","              documents= [query],\n","              ids = [query],\n","              metadatas = dict(zip(Keys, Values))\n","          )\n","\n","          result_dict = {'Metadatas': results['metadatas'][0], 'Documents': results['documents'][0], 'Distances': results['distances'][0], \"IDs\":results[\"ids\"][0]}\n","          results_df = pd.DataFrame.from_dict(result_dict)\n","          results_df\n","\n","    elif cache_results['distances'][0][0] <= threshold:\n","\n","          # Initialize empty lists to store the results\n","          ids = []\n","          documents = []\n","          distances = []\n","          metadatas = []\n","\n","          cache_result_dict = cache_results['metadatas'][0][0]\n","\n","          for key, value in cache_result_dict.items():\n","              if 'ids' in key:\n","                  ids.append(value)\n","              elif 'documents' in key:\n","                  documents.append(value)\n","              elif 'distances' in key:\n","                  distances.append(value)\n","              elif 'metadatas' in key:\n","                  metadatas.append(value)\n","\n","          # Create a DataFrame\n","          results_df = pd.DataFrame({\n","            'IDs': ids,\n","            'Documents': documents,\n","            'Distances': distances,\n","            'Metadatas': metadatas\n","          })\n","\n","    return results_df"]},{"cell_type":"code","source":["query = input(\"What is muggling your brain?\\n\")\n","\n","search_db_with_cache(\n","    query=query,\n","    collection = insurance_collection,\n","    n_results = 10,\n","    cache_collection = cache_collection,\n","    cache_threshold = 0.2)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":397},"id":"1NBrbDqXHayQ","executionInfo":{"status":"ok","timestamp":1718613715031,"user_tz":-330,"elapsed":11742,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"6fa15d66-473e-4e2e-8a62-703e25ea65af"},"execution_count":null,"outputs":[{"name":"stdout","output_type":"stream","text":["What is muggling your brain?\n","How long does the policy last?\n"]},{"output_type":"execute_result","data":{"text/plain":["  IDs                                          Documents            Distances  \\\n","0  21  t he principal may terminate the policyholder'...  0.37746309211796786   \n","1  40  any individual policy issued will then be in f...  0.37746755024492024   \n","2  58  section d - claim procedures article 1 - notic...  0.37859889112396294   \n","3  39  section f - individual purchase rights article...  0.37988388072617424   \n","4  38  i f coverage for a member or dependent termina...  0.38149143011624725   \n","5  34  b. a business assignment; or c. full-time stud...    0.381541293912057   \n","6  33  a member's insurance under this group policy f...  0.38425043459659053   \n","7  14  a. be actively engaged in business for profit ...  0.39167872371909274   \n","8  41  (4) premium will be based on the dependent's a...  0.39254247045237256   \n","9  59  a claimant may request an appeal of a claim de...   0.3942071026238462   \n","\n","                                           Metadatas  \n","0  {'Page_No.': 'Page 24', 'Policy_Name': 'Princi...  \n","1  {'Page_No.': 'Page 43', 'Policy_Name': 'Princi...  \n","2  {'Page_No.': 'Page 61', 'Policy_Name': 'Princi...  \n","3  {'Page_No.': 'Page 42', 'Policy_Name': 'Princi...  \n","4  {'Page_No.': 'Page 41', 'Policy_Name': 'Princi...  \n","5  {'Page_No.': 'Page 37', 'Policy_Name': 'Princi...  \n","6  {'Page_No.': 'Page 36', 'Policy_Name': 'Princi...  \n","7  {'Page_No.': 'Page 17', 'Policy_Name': 'Princi...  \n","8  {'Page_No.': 'Page 44', 'Policy_Name': 'Princi...  \n","9  {'Page_No.': 'Page 62', 'Policy_Name': 'Princi...  "],"text/html":["\n","  <div id=\"df-7377e97e-a613-41c5-bed7-dc404755fda8\" class=\"colab-df-container\">\n","    <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>IDs</th>\n","      <th>Documents</th>\n","      <th>Distances</th>\n","      <th>Metadatas</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>21</td>\n","      <td>t he principal may terminate the policyholder'...</td>\n","      <td>0.37746309211796786</td>\n","      <td>{'Page_No.': 'Page 24', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>40</td>\n","      <td>any individual policy issued will then be in f...</td>\n","      <td>0.37746755024492024</td>\n","      <td>{'Page_No.': 'Page 43', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>58</td>\n","      <td>section d - claim procedures article 1 - notic...</td>\n","      <td>0.37859889112396294</td>\n","      <td>{'Page_No.': 'Page 61', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>39</td>\n","      <td>section f - individual purchase rights article...</td>\n","      <td>0.37988388072617424</td>\n","      <td>{'Page_No.': 'Page 42', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>38</td>\n","      <td>i f coverage for a member or dependent termina...</td>\n","      <td>0.38149143011624725</td>\n","      <td>{'Page_No.': 'Page 41', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>5</th>\n","      <td>34</td>\n","      <td>b. a business assignment; or c. full-time stud...</td>\n","      <td>0.381541293912057</td>\n","      <td>{'Page_No.': 'Page 37', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>6</th>\n","      <td>33</td>\n","      <td>a member's insurance under this group policy f...</td>\n","      <td>0.38425043459659053</td>\n","      <td>{'Page_No.': 'Page 36', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>7</th>\n","      <td>14</td>\n","      <td>a. be actively engaged in business for profit ...</td>\n","      <td>0.39167872371909274</td>\n","      <td>{'Page_No.': 'Page 17', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>8</th>\n","      <td>41</td>\n","      <td>(4) premium will be based on the dependent's a...</td>\n","      <td>0.39254247045237256</td>\n","      <td>{'Page_No.': 'Page 44', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>9</th>\n","      <td>59</td>\n","      <td>a claimant may request an appeal of a claim de...</td>\n","      <td>0.3942071026238462</td>\n","      <td>{'Page_No.': 'Page 62', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","    <div class=\"colab-df-buttons\">\n","\n","  <div class=\"colab-df-container\">\n","    <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-7377e97e-a613-41c5-bed7-dc404755fda8')\"\n","            title=\"Convert this dataframe to an interactive table.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\" viewBox=\"0 -960 960 960\">\n","    <path d=\"M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z\"/>\n","  </svg>\n","    </button>\n","\n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    .colab-df-buttons div {\n","      margin-bottom: 4px;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","    <script>\n","      const buttonEl =\n","        document.querySelector('#df-7377e97e-a613-41c5-bed7-dc404755fda8 button.colab-df-convert');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      async function convertToInteractive(key) {\n","        const element = document.querySelector('#df-7377e97e-a613-41c5-bed7-dc404755fda8');\n","        const dataTable =\n","          await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                    [key], {});\n","        if (!dataTable) return;\n","\n","        const docLinkHtml = 'Like what you see? Visit the ' +\n","          '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","          + ' to learn more about interactive tables.';\n","        element.innerHTML = '';\n","        dataTable['output_type'] = 'display_data';\n","        await google.colab.output.renderOutput(dataTable, element);\n","        const docLink = document.createElement('div');\n","        docLink.innerHTML = docLinkHtml;\n","        element.appendChild(docLink);\n","      }\n","    </script>\n","  </div>\n","\n","\n","<div id=\"df-bff301ec-f068-4f10-85f0-ec6ef2daf3d1\">\n","  <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-bff301ec-f068-4f10-85f0-ec6ef2daf3d1')\"\n","            title=\"Suggest charts\"\n","            style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","  </button>\n","\n","<style>\n","  .colab-df-quickchart {\n","      --bg-color: #E8F0FE;\n","      --fill-color: #1967D2;\n","      --hover-bg-color: #E2EBFA;\n","      --hover-fill-color: #174EA6;\n","      --disabled-fill-color: #AAA;\n","      --disabled-bg-color: #DDD;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","      --bg-color: #3B4455;\n","      --fill-color: #D2E3FC;\n","      --hover-bg-color: #434B5C;\n","      --hover-fill-color: #FFFFFF;\n","      --disabled-bg-color: #3B4455;\n","      --disabled-fill-color: #666;\n","  }\n","\n","  .colab-df-quickchart {\n","    background-color: var(--bg-color);\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: var(--fill-color);\n","    height: 32px;\n","    padding: 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: var(--hover-bg-color);\n","    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: var(--button-hover-fill-color);\n","  }\n","\n","  .colab-df-quickchart-complete:disabled,\n","  .colab-df-quickchart-complete:disabled:hover {\n","    background-color: var(--disabled-bg-color);\n","    fill: var(--disabled-fill-color);\n","    box-shadow: none;\n","  }\n","\n","  .colab-df-spinner {\n","    border: 2px solid var(--fill-color);\n","    border-color: transparent;\n","    border-bottom-color: var(--fill-color);\n","    animation:\n","      spin 1s steps(1) infinite;\n","  }\n","\n","  @keyframes spin {\n","    0% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","      border-left-color: var(--fill-color);\n","    }\n","    20% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    30% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","      border-right-color: var(--fill-color);\n","    }\n","    40% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    60% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","    }\n","    80% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-bottom-color: var(--fill-color);\n","    }\n","    90% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","    }\n","  }\n","</style>\n","\n","  <script>\n","    async function quickchart(key) {\n","      const quickchartButtonEl =\n","        document.querySelector('#' + key + ' button');\n","      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.\n","      quickchartButtonEl.classList.add('colab-df-spinner');\n","      try {\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      } catch (error) {\n","        console.error('Error during call to suggestCharts:', error);\n","      }\n","      quickchartButtonEl.classList.remove('colab-df-spinner');\n","      quickchartButtonEl.classList.add('colab-df-quickchart-complete');\n","    }\n","    (() => {\n","      let quickchartButtonEl =\n","        document.querySelector('#df-bff301ec-f068-4f10-85f0-ec6ef2daf3d1 button');\n","      quickchartButtonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","    })();\n","  </script>\n","</div>\n","\n","    </div>\n","  </div>\n"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"dataframe","summary":"{\n  \"name\": \"    cache_threshold = 0\",\n  \"rows\": 10,\n  \"fields\": [\n    {\n      \"column\": \"IDs\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 10,\n        \"samples\": [\n          \"41\",\n          \"40\",\n          \"34\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Documents\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 10,\n        \"samples\": [\n          \"(4) premium will be based on the dependent's age and the standard rate of the principal for the policy form to be issued. b. purchase qualification a dependent will qualify for individual purchase if: (1) dependent life insurance, or any portion of it, terminates because he or she ceases to be a dependent as defined in part i; or because the member dies, ends active work, or ceases to be in a class eligible for such insurance; or (2) the dependent spouse's dependent life insurance terminates as described in part iii, section c; or (3) the dependent spouse's or civil union partner's dependent life insurance terminates because of divorce or separation or termination of a civil union partnership from the member; or (4) after the dependent has been continuously insured for dependent life insurance for at least five years, such insurance terminates because the group policy terminates, or is amended to eliminate dependent life insurance, or the member's insurance class; or (5) the dependent's life insurance terminates because the member's coverage during disability as described in part iv, section a, ceases because total disability ends and the member does not return to active work within 31 days ; or (6) the dependent's life insurance terminates because the member's accelerated benefits premium waiver period as described in part iv, section a, ceases and the member does not qualify for coverage during disability. c. application/effective date notice of the individual purchase right must be given to the member by the policyholder before insurance under this group policy terminates, or as soon as reasonably possible thereafter. a dependent must apply for individual purchase and the first premium for the individual policy must be paid to the principal within 31 days after the date dependent life insurance for the dependent terminates under this group policy. any individual policy issued will then be in force on the 32nd day after such termination date. d. individual policy amount the amount of insurance that a dependent may purchase may vary: this policy has been updated effective january 1, 2014 part iii - individual requirements and rights gc 6011 section f - individual purchase rights, page 3\",\n          \"any individual policy issued will then be in force on the 32nd day following such termination date. d. individual policy amount the amount of insurance that may be purchased may vary: (1) if termination is as described in b. (1) above, the maximum amount will be the member life insurance benefit in force on the date of termination or the portion of member life insurance that has terminated, less any individual policy amount purchased earlier under this article 1, and less any accelerated benefit payment as described in part iv, section a, article 7. (2) if termination is as described in b. (2) above, the maximum amount will be the lesser of: - $10,000; or - the member life insurance benefit in force on the date of termination, less any accelerated benefit payment as described in part iv, section a, article 7 and less the amount for which the member becomes eligible under any group policy within 31 days. (3) if termination is as described in b. (3) above, the maximum amount will be the coverage during disability benefit in force on the date total disability ceases, less any individual policy amount purchased earlier under this article 1, and less any accelerated benefit payment as described in part iv, section a, article 7. (4) if termination is as described in b. (4) above, the maximum amount will be the member life insurance benefit in force on the date the member ceases active work, less any individual policy amount purchased earlier under this article 1, and less any accelerated benefit payment as described in part iv, section a, article 7. article 2 - dependent life insurance a. individual policy if a dependent qualifies and makes timely application, he or she may purchase an individual policy of life insurance under these terms: (1) the dependent will not be required to submit proof of good health. (2) the policy will be for life insurance only. no disability or other benefits will be included. (3) the policy will be on one of the forms, other than term insurance, then issued by the principal to persons in the risk class to which the dependent belongs on the individual policy's effective date. this policy has been updated effective january 1, 2014 part iii - individual requirements and rights gc 6011 section f - individual purchase rights, page 2\",\n          \"b. a business assignment; or c. full-time student status, provided the member or dependent is either: (1) enrolled and attending an accredited school in a foreign country; or (2) is participating in an academic program in a foreign country, for which the institution of higher learning at which the student is enrolled in the u.s. grants academic credit. the six-month period will not be reduced for any time covered under a prior policy. if a member or dependent is outside the united states for any other reason than those listed above, coverage for the person concerned will automatically terminate. this policy has been updated effective january 1, 2014 part iii - individual requirements and rights gc 6008 section c - individual terminations, page 3\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Distances\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 10,\n        \"samples\": [\n          \"0.39254247045237256\",\n          \"0.37746755024492024\",\n          \"0.381541293912057\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Metadatas\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 10,\n        \"samples\": [\n          \"{'Page_No.': 'Page 44', 'Policy_Name': 'Principal-Sample-Life-Insurance-Policy'}\",\n          \"{'Page_No.': 'Page 43', 'Policy_Name': 'Principal-Sample-Life-Insurance-Policy'}\",\n          \"{'Page_No.': 'Page 37', 'Policy_Name': 'Principal-Sample-Life-Insurance-Policy'}\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    }\n  ]\n}"}},"metadata":{},"execution_count":17}]},{"cell_type":"markdown","source":["### 2.3 Re-Ranking with a Cross Encoder\n"],"metadata":{"id":"fuf0Lr635zi3"}},{"cell_type":"code","source":["# Import the CrossEncoder library from sentence_transformers\n","from sentence_transformers import CrossEncoder, util\n","# Initialise the cross encoder model\n","cross_encoder = CrossEncoder('cross-encoder/ms-marco-MiniLM-L-6-v2')"],"metadata":{"id":"ezu-JMdZLL2u"},"execution_count":null,"outputs":[]},{"cell_type":"code","execution_count":null,"metadata":{"id":"nLcDXPgIzWNo"},"outputs":[],"source":["def re_rank(query, results_df):\n","\n","  # Generate the cross_encoder scores for these pairs\n","  cross_inputs = [[query, response] for response in results_df['Documents']]\n","  cross_rerank_scores = cross_encoder.predict(cross_inputs)\n","\n","  # Store the rerank_scores in results_df\n","  results_df['Reranked_scores'] = cross_rerank_scores\n","\n","  # Return the top 3 results after reranking\n","  results_df = results_df.sort_values(by='Reranked_scores', ascending=False)\n","\n","  return results_df[[\"Documents\", \"Metadatas\"]][:3]"]},{"cell_type":"code","source":["\n","query = input(\"What is muggling your brain?\\n\")\n","\n","results_df = search_db_with_cache(\n","    query=query,\n","    collection = insurance_collection,\n","    n_results = 10,\n","    cache_collection = cache_collection,\n","    cache_threshold = 0.4\n","  )\n","\n","top_3_RAG = re_rank(\n","    query,\n","    results_df\n","  )\n","\n","top_3_RAG"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":178},"id":"KD1oLnT2JbHA","executionInfo":{"status":"ok","timestamp":1718613750307,"user_tz":-330,"elapsed":23921,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"4fb7d674-4bf7-46cb-d924-51b29b67f17d"},"execution_count":null,"outputs":[{"name":"stdout","output_type":"stream","text":["What is muggling your brain?\n","How long does the policy Last? \n"]},{"output_type":"execute_result","data":{"text/plain":["                                           Documents  \\\n","4  i f coverage for a member or dependent termina...   \n","0  t he principal may terminate the policyholder'...   \n","2  section d - claim procedures article 1 - notic...   \n","\n","                                           Metadatas  \n","4  {'Page_No.': 'Page 41', 'Policy_Name': 'Princi...  \n","0  {'Page_No.': 'Page 24', 'Policy_Name': 'Princi...  \n","2  {'Page_No.': 'Page 61', 'Policy_Name': 'Princi...  "],"text/html":["\n","  <div id=\"df-2278a5a5-a9ad-4835-8ca1-2804ff46aafc\" class=\"colab-df-container\">\n","    <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Documents</th>\n","      <th>Metadatas</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>4</th>\n","      <td>i f coverage for a member or dependent termina...</td>\n","      <td>{'Page_No.': 'Page 41', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>0</th>\n","      <td>t he principal may terminate the policyholder'...</td>\n","      <td>{'Page_No.': 'Page 24', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>section d - claim procedures article 1 - notic...</td>\n","      <td>{'Page_No.': 'Page 61', 'Policy_Name': 'Princi...</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","    <div class=\"colab-df-buttons\">\n","\n","  <div class=\"colab-df-container\">\n","    <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-2278a5a5-a9ad-4835-8ca1-2804ff46aafc')\"\n","            title=\"Convert this dataframe to an interactive table.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\" viewBox=\"0 -960 960 960\">\n","    <path d=\"M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z\"/>\n","  </svg>\n","    </button>\n","\n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    .colab-df-buttons div {\n","      margin-bottom: 4px;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","    <script>\n","      const buttonEl =\n","        document.querySelector('#df-2278a5a5-a9ad-4835-8ca1-2804ff46aafc button.colab-df-convert');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      async function convertToInteractive(key) {\n","        const element = document.querySelector('#df-2278a5a5-a9ad-4835-8ca1-2804ff46aafc');\n","        const dataTable =\n","          await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                    [key], {});\n","        if (!dataTable) return;\n","\n","        const docLinkHtml = 'Like what you see? Visit the ' +\n","          '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","          + ' to learn more about interactive tables.';\n","        element.innerHTML = '';\n","        dataTable['output_type'] = 'display_data';\n","        await google.colab.output.renderOutput(dataTable, element);\n","        const docLink = document.createElement('div');\n","        docLink.innerHTML = docLinkHtml;\n","        element.appendChild(docLink);\n","      }\n","    </script>\n","  </div>\n","\n","\n","<div id=\"df-9bdc57b6-3b95-4a12-a397-c21074f5b034\">\n","  <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-9bdc57b6-3b95-4a12-a397-c21074f5b034')\"\n","            title=\"Suggest charts\"\n","            style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","  </button>\n","\n","<style>\n","  .colab-df-quickchart {\n","      --bg-color: #E8F0FE;\n","      --fill-color: #1967D2;\n","      --hover-bg-color: #E2EBFA;\n","      --hover-fill-color: #174EA6;\n","      --disabled-fill-color: #AAA;\n","      --disabled-bg-color: #DDD;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","      --bg-color: #3B4455;\n","      --fill-color: #D2E3FC;\n","      --hover-bg-color: #434B5C;\n","      --hover-fill-color: #FFFFFF;\n","      --disabled-bg-color: #3B4455;\n","      --disabled-fill-color: #666;\n","  }\n","\n","  .colab-df-quickchart {\n","    background-color: var(--bg-color);\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: var(--fill-color);\n","    height: 32px;\n","    padding: 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: var(--hover-bg-color);\n","    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: var(--button-hover-fill-color);\n","  }\n","\n","  .colab-df-quickchart-complete:disabled,\n","  .colab-df-quickchart-complete:disabled:hover {\n","    background-color: var(--disabled-bg-color);\n","    fill: var(--disabled-fill-color);\n","    box-shadow: none;\n","  }\n","\n","  .colab-df-spinner {\n","    border: 2px solid var(--fill-color);\n","    border-color: transparent;\n","    border-bottom-color: var(--fill-color);\n","    animation:\n","      spin 1s steps(1) infinite;\n","  }\n","\n","  @keyframes spin {\n","    0% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","      border-left-color: var(--fill-color);\n","    }\n","    20% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    30% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","      border-right-color: var(--fill-color);\n","    }\n","    40% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    60% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","    }\n","    80% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-bottom-color: var(--fill-color);\n","    }\n","    90% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","    }\n","  }\n","</style>\n","\n","  <script>\n","    async function quickchart(key) {\n","      const quickchartButtonEl =\n","        document.querySelector('#' + key + ' button');\n","      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.\n","      quickchartButtonEl.classList.add('colab-df-spinner');\n","      try {\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      } catch (error) {\n","        console.error('Error during call to suggestCharts:', error);\n","      }\n","      quickchartButtonEl.classList.remove('colab-df-spinner');\n","      quickchartButtonEl.classList.add('colab-df-quickchart-complete');\n","    }\n","    (() => {\n","      let quickchartButtonEl =\n","        document.querySelector('#df-9bdc57b6-3b95-4a12-a397-c21074f5b034 button');\n","      quickchartButtonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","    })();\n","  </script>\n","</div>\n","\n","  <div id=\"id_de2d61db-8601-4b6a-a9af-8645965e90c4\">\n","    <style>\n","      .colab-df-generate {\n","        background-color: #E8F0FE;\n","        border: none;\n","        border-radius: 50%;\n","        cursor: pointer;\n","        display: none;\n","        fill: #1967D2;\n","        height: 32px;\n","        padding: 0 0 0 0;\n","        width: 32px;\n","      }\n","\n","      .colab-df-generate:hover {\n","        background-color: #E2EBFA;\n","        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","        fill: #174EA6;\n","      }\n","\n","      [theme=dark] .colab-df-generate {\n","        background-color: #3B4455;\n","        fill: #D2E3FC;\n","      }\n","\n","      [theme=dark] .colab-df-generate:hover {\n","        background-color: #434B5C;\n","        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","        fill: #FFFFFF;\n","      }\n","    </style>\n","    <button class=\"colab-df-generate\" onclick=\"generateWithVariable('top_3_RAG')\"\n","            title=\"Generate code using this dataframe.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","       width=\"24px\">\n","    <path d=\"M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z\"/>\n","  </svg>\n","    </button>\n","    <script>\n","      (() => {\n","      const buttonEl =\n","        document.querySelector('#id_de2d61db-8601-4b6a-a9af-8645965e90c4 button.colab-df-generate');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      buttonEl.onclick = () => {\n","        google.colab.notebook.generateWithVariable('top_3_RAG');\n","      }\n","      })();\n","    </script>\n","  </div>\n","\n","    </div>\n","  </div>\n"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"dataframe","variable_name":"top_3_RAG","summary":"{\n  \"name\": \"top_3_RAG\",\n  \"rows\": 3,\n  \"fields\": [\n    {\n      \"column\": \"Documents\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 3,\n        \"samples\": [\n          \"i f coverage for a member or dependent terminates because the person is outside of the united states as discussed in part iii, section c, article 5, the member or dependent may become eligible again for coverage under this group policy, but only if: a. the member or dependent return to the united states within six months of the date on which coverage terminated because the person is outside of the united states; and b. in the case of a member, the member returns to active work in the united states for the policyholder for a period of at least 30 consecutive days. the member will be eligible for coverage on the day immediately following completion of the 30 consecutive days of active work; and c. in the case of the dependent, he or she remains in the united states for 30 consecutive days. if the dependent does so, he or she will be eligible for reinstatement of coverage on the day after completion of the 30 consecutive days of residence. the reinstated coverage will be on the same basis as that being provided on the date coverage is reinstated. however, any restrictions on this coverage that were in effect before reinstatement will continue to apply. if the member or dependent does not complete the 30 consecutive days of residence, the coverage for such person will not be reinstated. this policy has been updated effective january 1, 2014 part iii - individual requirements and rights gc 6010 section e - reinstatement, page 2\",\n          \"t he principal may terminate the policyholder's coverage on any premium due date if the policyholder relocates to a state where this group policy is not marketed, by giving the policyholder 31 days advanced notice in writing. article 4 - policyholder responsibility to members if this group policy terminates for any reason, the policyholder must: a. notify each member of the effective date of the termination; and b. refund or otherwise account to each member all contributions received or withheld from members for premiums not actually paid to the principal. this policy has been updated effective january 1, 2014 part ii - policy administration gc 6005 section c - policy termination, page 2\",\n          \"section d - claim procedures article 1 - notice of claim written notice must be sent to the principal by or for a member or dependent who wishes to file claim for benefits under this group policy. this notice must be sent within 20 days after the date of the loss for which claim is being made. failure to give notice within the time specified will not invalidate or reduce any claim if notice is given as soon as reasonably possible. article 2 - claim forms the principal, when it receives notice of claim, will provide appropriate claim forms for filing proof of loss. if the forms are not provided within 15 days after the principal receives notice, the person will be considered to have complied with the requirements of this group policy upon submitting, within the time specified below for filing proof of loss, written proof covering the occurrence, character, and extent of the loss. article 3 - proof of loss written proof of loss must be sent to the principal within 90 days after the date of the loss. proof required includes the date, nature, and extent of the loss. the principal may request additional information to substantiate loss or require a signed unaltered authorization to obtain that information from the provider. failure to comply with the request of the principal could result in declination of the claim. for purposes of satisfying the claims processing timing requirements of the employee retirement income security act (erisa), receipt of claim will be considered to be met when the appropriate claim form is received by the principal. article 4 - payment, denial, and review erisa permits up to 45 days from receipt of claim for processing the claim. if a claim cannot be processed due to incomplete information, the principal will send a written explanation prior to the expiration of the 45 days. the claimant is then allowed up to 45 days to provide all additional information requested. the principal is permitted two 30-day extensions for processing an incomplete claim. written notification will be sent to the claimant regarding the extension. in actual practice, benefits under this group policy will be payable sooner, provided the principal receives complete and proper proof of loss. further, if a claim is not payable or cannot be processed, the principal will submit a detailed explanation of the basis for its denial. this policy has been updated effective january 1, 2014 part iv - benefits gc 6018 section d - claim procedures, page 1\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Metadatas\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 3,\n        \"samples\": [\n          \"{'Page_No.': 'Page 41', 'Policy_Name': 'Principal-Sample-Life-Insurance-Policy'}\",\n          \"{'Page_No.': 'Page 24', 'Policy_Name': 'Principal-Sample-Life-Insurance-Policy'}\",\n          \"{'Page_No.': 'Page 61', 'Policy_Name': 'Principal-Sample-Life-Insurance-Policy'}\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    }\n  ]\n}"}},"metadata":{},"execution_count":20}]},{"cell_type":"markdown","metadata":{"id":"si6lniu8rfDO"},"source":["## <font color = blue> 3.  Layer 3 : RAG Layer\n"]},{"cell_type":"code","source":["def convert_to_dictionary (top_3_RAG) :\n","\n","  top_3_RAG_dict = {}\n","\n","  x = 1\n","\n","  for i in top_3_RAG.values:\n","\n","    doc = i[0]\n","    try :\n","      meta = eval(i[1])\n","      meta[\"Policy_Name\"] = meta[\"Policy_Name\"].replace('_',' ')\n","      mets = f'In the page {meta[\"Page_No.\"]} of the policy {meta[\"Policy_Name\"]}'\n","    except :\n","      meta = i[1]\n","\n","    top_3_RAG_dict[f'result_{x}'] = {\n","        'reference' : meta,\n","        'document_text' : doc\n","    }\n","    x+=1\n","\n","  return top_3_RAG_dict"],"metadata":{"id":"KnUeNixMYUS9"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["# Define the function to generate the response. Provide a comprehensive prompt that passes the user query and the top 3 results to the model\n","\n","def generate_response(query, results_df):\n","    \"\"\"\n","    Generate a response using GPT-3.5's ChatCompletion based on the user query and retrieved information.\n","    \"\"\"\n","\n","    top_3_RAG_dict = convert_to_dictionary(results_df)\n","\n","    messages = [\n","                  {\n","                    \"role\": \"system\",\n","                    \"content\": f\"\"\"\n","                                    You are a proficient assistant specializing in the insurance domain, adept at responding to user inquiries concerning insurance policies and related documents.\"\"\"\n","                  },\n","                  {\n","                    \"role\": \"user\",\n","                    \"content\": f\"\"\"\n","                                    You are an insurance domain assistant. Read and break down the user query into key elements and sub-questions. Analyze the 'search_results' JSON to find relevant documents and extract pertinent information, including reformatting tables if necessary. Compile the extracted data into a concise, direct response, citing policy names and page numbers from the 'metadata'. Review the response for clarity and completeness, stating if the query is irrelevant if necessary.\n","\n","                                    ### User Query:\n","                                    '{query}'.\n","\n","                                    ### search_results :\n","                                   '{top_3_RAG_dict}'\n","                                    The key is the metadata and the value is the document text.\n","\n","                                    Here is the detailed chain of thought process to follow:\n","\n","                                    **Step 1: Understand the User Query**\n","                                    - Carefully read the user query '{query}'.\n","                                    - Re-write the query with different aspects or sub-questions. Identify key elements such as the type of coverage, conditions, dates, eligibility, and any specific scenarios mentioned.\n","\n","                                    **Step 2: Analyze the Dataframe for Relevant Information**\n","                                    - Examine the 'search_results' JSON to identify which documents might contain relevant information.\n","                                    - For each document in the JSON, scan the text to determine its relevance to the query aspects identified in Step 1.\n","\n","                                    **Step 3: Extract and Interpret Relevant Information**\n","                                    - Extract information from the relevant documents that address the different aspects of the query.\n","                                    - [IMP]**If multiple documents provide relevant details, synthesize the information to form a coherent response**\n","                                    - Write down the policy exerpt in simple language\n","                                    - For any tables present in the documents, reformat the data into a clear and understandable table.\n","\n","                                    **Step 4: Formulate the Response**\n","                                    - Compile the extracted information into a well-structured and informative answer.\n","                                    - Ensure the response is concise, direct, and addresses all aspects of the user query.\n","                                    - Use the 'metadata' to cite the policy names and page numbers for each piece of information used.\n","\n","                                    **Step 5: Finalize and Cite the Response**\n","                                    - Review the response to ensure clarity and completeness.\n","                                    - Include citations for each piece of information, referencing the policy name(s) and page number(s) as obtained from the 'metadata' column.\n","                                    - If the documents do not contain relevant information, clearly state that the query is irrelevant and provide any guidance for further searches if possible.\n","\n","                                    Follow the guidelines below when performing the task :\n","                                      1. Try to provide relevant/accurate numbers if available.\n","                                      2. You don’t have to necessarily use all the information in the dataframe. Only choose information that is relevant.\n","                                      3. If the document text has tables with relevant information, please reformat the table and return the final information in a tabular in format.\n","                                      3. Use the Metadatas columns in the dataframe to retrieve and cite the policy name(s) and page numbers(s) as citation.\n","                                      4. If you can't provide the complete answer, please also provide any information that will help the user to search specific sections in the relevant cited documents.\n","                                      5. You are a customer facing assistant, so do not provide any information on internal workings, just answer the query directly.\n","\n","                    \"\"\"\n","                  },\n","              ]\n","\n","    response = openai.chat.completions.create(\n","        model=\"gpt-3.5-turbo\",\n","        messages=messages,\n","        temperature = 1.2\n","    )\n","\n","    return response.choices[0].message.content.split('\\n')"],"metadata":{"id":"Mt7nMRh_Oid6"},"execution_count":null,"outputs":[]},{"cell_type":"code","execution_count":null,"metadata":{"id":"wnRLO3ONmjFZ"},"outputs":[],"source":["def run_rag(debug=False):\n","  \"\"\"\n","    This function asks for the users query and returns the result to the user\n","  \"\"\"\n","  # Generate the response\n","\n","  print(\"The converation with the policy starts now, type\", color.BOLD +\"\\'Exit\\'\"+color.END , \"to\",color.BOLD +\"stop\"+color.END,\"\\n\")\n","\n","  print(color.BOLD + color.DARKCYAN + \"Agent : \" + color.END)\n","  print(\"What is muggling your brain?\\n\")\n","  print(color.BOLD + color.PURPLE + \"You: \" + color.END)\n","  query = input()\n","  print()\n","\n","  while(query!='Exit'):\n","\n","    results_df = search_db_with_cache(\n","        query=query,\n","        collection = insurance_collection,\n","        n_results = 10,\n","        cache_collection = cache_collection,\n","        cache_threshold = 0.2\n","      )\n","\n","    top_3_RAG = re_rank(\n","        query,\n","        results_df\n","      )\n","\n","    if debug:\n","      # display(query)\n","      # display(results_df)\n","      display(top_3_RAG)\n","\n","    response = generate_response(query, top_3_RAG)\n","\n","    print(color.BOLD + color.DARKCYAN + \"Agent : \" + color.END)\n","    print(\"\\n\".join(response))\n","    print(\"\\nWhat else is muggling your brain?\\n\")\n","    print(color.BOLD + color.PURPLE + \"You: \" + color.END)\n","    query = input()\n","    print()\n"]},{"cell_type":"code","source":["run_rag()"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"_1yWx7_kUx98","executionInfo":{"status":"ok","timestamp":1718617565913,"user_tz":-330,"elapsed":38459,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"8fafac3e-3fe0-413c-973b-77e7868a65fa"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["The converation with the policy starts now, type \u001b[1m'Exit'\u001b[0m to \u001b[1mstop\u001b[0m \n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","What is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","How many years does the policy cover my life for?\n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","\n","**Response:**\n","\n","Based on the search results, the \"Principal-Sample-Life-Insurance-Policy\" document provides relevant information regarding the coverage duration of the policy for both members and dependents. Here is a concise summary:\n","\n","- For a member, individual purchase rights allow the conversion of group coverage into an individual policy for life insurance only. The policy does not include disability or other benefits.\n","- A member qualifies for individual purchase if their insurance under the group policy terminates after being continuously insured for at least five years.\n","- An individual policy must be applied for within 31 days after the termination date of the member's life insurance.\n","- The policy includes age-based premiums and is updated effective January 1, 2014.\n","\n","For more detailed information and specific durations, please refer to:\n","- Document: Principal-Sample-Life-Insurance-Policy\n","- Page Number: Page 42 for member-related details\n","\n","Additionally, the document provides information about dependent coverage, including the basis for premium calculations and the termination conditions for dependent life insurance.\n","\n","For further information on the coverage duration and specific years, refer to:\n","- Document: Principal-Sample-Life-Insurance-Policy\n","- Page Number: Page 44 for dependent-related information\n","\n","\n","If you require additional details or have specific scenarios in mind, referring to the highlighted pages in the mentioned documents can provide you with precise answers regarding the coverage duration of the policy for your life.\n","\n","If there are any other follow-up questions or specific areas you would like to explore, feel free to let me know for further assistance.\n","\n","What else is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","What happens if I stop paying the installment\n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","### Response:\n","\n","Based on the provided 'search_results' JSON data, the query \"What happens if I stop paying the installment\" can be addressed through the following relevant extract from the insurance policy \"Principal-Sample-Life-Insurance-Policy.\"\n","\n","#### Policy Termination:\n","- **Policy Name:** Principal-Sample-Life-Insurance-Policy\n","- **Page Number:** 23\n","\n","In the event of not paying the premium installment, the group policy will terminate if the total premium due is not received by the end of the grace period. Failure to pay within the grace period will be considered notice to discontinue the policy. The policyholder can terminate the policy by providing written notice before the premium due date. Furthermore, the principal has the right to nonrenew or terminate the policy under specific conditions outlined in the document.\n","\n","### Additional Information:\n","If you wish to explore further regarding the implications of stopping payment installments or additional conditions related to policy termination, it is advisable to refer to the sections provided earlier in this summary, citing policy_name and page_number from the metadata for detailed insights.\n","\n","Should you require more detailed information or if you would like to delve into specific sections of the cited documents, please let me know to assist you further.\n","\n","What else is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","Exit\n","\n"]}]},{"cell_type":"markdown","source":["## <font color = Purple> 4. Three Question Test"],"metadata":{"id":"hzuuEcUq_xag"}},{"cell_type":"markdown","source":["\n","\n","> **What are the policy coverage details for accidents involving public transport?**\n","\n","    Interpretation Needed: Understanding the specific conditions under which coverage can be continued and recognizing the distinctions made for different reasons for being outside the United States.\n","\n","\n","\n","> **How does the policy address claims related to natural disasters?**\n","\n","    Interpretation Needed: Analyzing the policy's provisions for handling fraudulent claims and understanding the steps taken by the insurer to terminate coverage based on fraudulent activities\n","\n","> **What benefits are available if the insured is permanently disabled in an accident?**\n","\n","    Interpretation Needed: Interpreting the requirements for continuation of coverage for a dependent child with a developmental disability or physical handicap, and identifying the necessary documentation and proof that must be submitted"],"metadata":{"id":"RFFsieSw_1bK"}},{"cell_type":"code","source":["# run_rag()"],"metadata":{"id":"-0lA_pgoAOX0","executionInfo":{"status":"ok","timestamp":1718620337683,"user_tz":-330,"elapsed":377,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}}},"execution_count":111,"outputs":[]},{"cell_type":"markdown","source":["#### Question 1"],"metadata":{"id":"IrT6PIsayAze"}},{"cell_type":"code","source":["run_rag(debug=True)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":1505},"id":"LKLoDS8DbbZ3","executionInfo":{"status":"ok","timestamp":1718620375478,"user_tz":-330,"elapsed":30432,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"17d65011-a2ff-4da8-c031-d8a5712a0b7d"},"execution_count":112,"outputs":[{"output_type":"stream","name":"stdout","text":["The converation with the policy starts now, type \u001b[1m'Exit'\u001b[0m to \u001b[1mstop\u001b[0m \n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","What is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","What are the policy coverage details for accidents involving public transport?\n","\n"]},{"output_type":"display_data","data":{"text/plain":["                                           Documents  \\\n","0  exposure exposure to the elements will be pres...   \n","1  f . claim requirements listed in part iv, sect...   \n","7  % of scheduled covered loss benefit loss of sp...   \n","\n","                                           Metadatas  \n","0  {'Page_No.': '55', 'Policy_Name': 'Principal-S...  \n","1  {'Page_No.': '54', 'Policy_Name': 'Principal-S...  \n","7  {'Page_No.': '57', 'Policy_Name': 'Principal-S...  "],"text/html":["\n","  <div id=\"df-60af0ce4-4592-40ff-976b-c48d1b58b413\" class=\"colab-df-container\">\n","    <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Documents</th>\n","      <th>Metadatas</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>exposure exposure to the elements will be pres...</td>\n","      <td>{'Page_No.': '55', 'Policy_Name': 'Principal-S...</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>f . claim requirements listed in part iv, sect...</td>\n","      <td>{'Page_No.': '54', 'Policy_Name': 'Principal-S...</td>\n","    </tr>\n","    <tr>\n","      <th>7</th>\n","      <td>% of scheduled covered loss benefit loss of sp...</td>\n","      <td>{'Page_No.': '57', 'Policy_Name': 'Principal-S...</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","    <div class=\"colab-df-buttons\">\n","\n","  <div class=\"colab-df-container\">\n","    <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-60af0ce4-4592-40ff-976b-c48d1b58b413')\"\n","            title=\"Convert this dataframe to an interactive table.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\" viewBox=\"0 -960 960 960\">\n","    <path d=\"M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z\"/>\n","  </svg>\n","    </button>\n","\n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    .colab-df-buttons div {\n","      margin-bottom: 4px;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","    <script>\n","      const buttonEl =\n","        document.querySelector('#df-60af0ce4-4592-40ff-976b-c48d1b58b413 button.colab-df-convert');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      async function convertToInteractive(key) {\n","        const element = document.querySelector('#df-60af0ce4-4592-40ff-976b-c48d1b58b413');\n","        const dataTable =\n","          await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                    [key], {});\n","        if (!dataTable) return;\n","\n","        const docLinkHtml = 'Like what you see? Visit the ' +\n","          '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","          + ' to learn more about interactive tables.';\n","        element.innerHTML = '';\n","        dataTable['output_type'] = 'display_data';\n","        await google.colab.output.renderOutput(dataTable, element);\n","        const docLink = document.createElement('div');\n","        docLink.innerHTML = docLinkHtml;\n","        element.appendChild(docLink);\n","      }\n","    </script>\n","  </div>\n","\n","\n","<div id=\"df-16a6676c-abe0-4887-bcef-f5091841c0a2\">\n","  <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-16a6676c-abe0-4887-bcef-f5091841c0a2')\"\n","            title=\"Suggest charts\"\n","            style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","  </button>\n","\n","<style>\n","  .colab-df-quickchart {\n","      --bg-color: #E8F0FE;\n","      --fill-color: #1967D2;\n","      --hover-bg-color: #E2EBFA;\n","      --hover-fill-color: #174EA6;\n","      --disabled-fill-color: #AAA;\n","      --disabled-bg-color: #DDD;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","      --bg-color: #3B4455;\n","      --fill-color: #D2E3FC;\n","      --hover-bg-color: #434B5C;\n","      --hover-fill-color: #FFFFFF;\n","      --disabled-bg-color: #3B4455;\n","      --disabled-fill-color: #666;\n","  }\n","\n","  .colab-df-quickchart {\n","    background-color: var(--bg-color);\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: var(--fill-color);\n","    height: 32px;\n","    padding: 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: var(--hover-bg-color);\n","    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: var(--button-hover-fill-color);\n","  }\n","\n","  .colab-df-quickchart-complete:disabled,\n","  .colab-df-quickchart-complete:disabled:hover {\n","    background-color: var(--disabled-bg-color);\n","    fill: var(--disabled-fill-color);\n","    box-shadow: none;\n","  }\n","\n","  .colab-df-spinner {\n","    border: 2px solid var(--fill-color);\n","    border-color: transparent;\n","    border-bottom-color: var(--fill-color);\n","    animation:\n","      spin 1s steps(1) infinite;\n","  }\n","\n","  @keyframes spin {\n","    0% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","      border-left-color: var(--fill-color);\n","    }\n","    20% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    30% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","      border-right-color: var(--fill-color);\n","    }\n","    40% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    60% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","    }\n","    80% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-bottom-color: var(--fill-color);\n","    }\n","    90% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","    }\n","  }\n","</style>\n","\n","  <script>\n","    async function quickchart(key) {\n","      const quickchartButtonEl =\n","        document.querySelector('#' + key + ' button');\n","      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.\n","      quickchartButtonEl.classList.add('colab-df-spinner');\n","      try {\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      } catch (error) {\n","        console.error('Error during call to suggestCharts:', error);\n","      }\n","      quickchartButtonEl.classList.remove('colab-df-spinner');\n","      quickchartButtonEl.classList.add('colab-df-quickchart-complete');\n","    }\n","    (() => {\n","      let quickchartButtonEl =\n","        document.querySelector('#df-16a6676c-abe0-4887-bcef-f5091841c0a2 button');\n","      quickchartButtonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","    })();\n","  </script>\n","</div>\n","\n","    </div>\n","  </div>\n"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"dataframe","summary":"{\n  \"name\": \"run_rag(debug=True)\",\n  \"rows\": 3,\n  \"fields\": [\n    {\n      \"column\": \"Documents\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 3,\n        \"samples\": [\n          \"exposure exposure to the elements will be presumed to be an injury if: a. such exposure is due to an accidental bodily injury; and b. within 365 days after the injury, the member incurs a loss that is the result of the exposure; and c. this group policy would have covered the injury resulting from the accident. article 4 - seat belt/airbag benefit if the member loses his or her life as a result of an accidental injury sustained while driving or riding in an automobile, an additional benefit of $10,000 will be paid to the beneficiary named for member life insurance, provided all benefit qualifications as described in article 2 are met and: a. the automobile is equipped with factory-installed seat belts; and b. the seat belt was in actual use by the member and properly fastened at the time of the accident; and c. the position of the seat belt is certified in the official report of the accident or by the investigating officer. this additional benefit payment will also apply if the member was driving an automobile equipped with a properly functioning driver-side air bag or riding as a passenger in an automobile equipped with a properly functioning passenger-side air bag, although the member's seat belt may not have been fastened at the time of the accident. the properly functioning and/or deployment of the air bag must be certified in the official report of the accident or by the investigating officer. for the purpose of this benefit, \\\"automobile\\\" means a four-wheel passenger vehicle, station wagon, pick-up truck, or van-type vehicle, but excludes recreational-type vehicles such as a \\\"dune-buggy\\\" or an \\\"all-terrain\\\" vehicle. the term \\\"seat belt\\\" means a factory-installed device that forms an occupant restraint and injury avoidance system. article 5 - loss of use or paralysis benefit this policy has been updated effective january 1, 2014 part iv - benefits gc 6015 section b - member accidental death and dismemberment insurance,  3\",\n          \"f . claim requirements listed in part iv, section d, must be satisfied; and g. all medical evidence must be satisfactory to the principal. article 3 - benefits payable if all of the benefit qualifications are met, the principal will pay: a. 100% of the scheduled benefit (or approved amount, if applicable) in force for loss of life; or b. 50% of the scheduled benefit (or approved amount, if applicable) in force if one hand is severed at or above the wrist; or c. 25% of the scheduled benefit (or approved amount, if applicable) in force for loss of thumb and index finger on the same hand; or d. 50% of the scheduled benefit (or approved amount, if applicable) in force if one foot is severed at or above the ankle; or e. 50% of the scheduled benefit (or approved amount, if applicable) in force if the sight of one eye is permanently lost (for this purpose, vision not correctable to better than 20/200 will be considered loss of sight.); or f. 100% of the scheduled benefit (or approved amount, if applicable) in force for more than one of the losses listed in b., d., or e. above. total payment for all losses under this article 3 that result from the same accident will not exceed the scheduled benefit (or approved amount, if applicable). payment for loss of life will be to the beneficiary named for member life insurance. payment will be subject to the beneficiary, facility of payment and settlement of proceeds provisions of part iv, section a. payment for all other losses will be to the member. disappearance it will be presumed that a member has lost his or her life if: a. the member's body has not been found within 365 days after the disappearance of a conveyance in which the member was an occupant at the time of disappearance; and b. the disappearance of the conveyance was due to its accidental wrecking or sinking; and c. this group policy would have covered the injury resulting from the accident. this policy has been updated effective january 1, 2014 part iv - benefits gc 6015 section b - member accidental death and dismemberment insurance,  2\",\n          \"% of scheduled covered loss benefit loss of speech and/or hearing speech and hearing 100% speech or hearing 50% hearing in one ear 25% loss must be determined by a physician to be permanent, complete, and irreversible. total payment for all losses that result from the same accident will not exceed the scheduled benefit (or approved amount, if applicable). payment for loss will be to the member. for this benefit, the term \\\"loss\\\" means a total and irrevocable loss of speech or hearing, which has continued for 12 consecutive months. article 7 - repatriation benefit if a benefit is paid under this section b for loss of the member's life and death occurred at least 100 miles away from the member's permanent place of residence, all customary and reasonable expenses incurred for preparation of the body and its transportation to the place of burial or cremation will be paid up to a maximum benefit payment of $2,000. article 8 - educational benefit if a benefit is paid under this section b for loss of the member's life, an extra benefit of $3,000 will be paid annually for a maximum of four years to each qualified student. this annual benefit will be paid consecutively, while the qualified student continues his or her education as a full-time student at an accredited post-secondary school. for the purpose of this benefit, \\\"qualified student\\\" means a dependent child who is, at the time of the member's death, a full-time student at an accredited post-secondary school. a 12th grade student will become a qualified student if he or she enrolls in an accredited post- secondary school within 12 months of the member's death. article 9 - limitations payment will not be made for any loss to which a contributing cause is: this policy has been updated effective january 1, 2014 part iv - benefits gc 6015 section b - member accidental death and dismemberment insurance,  5\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Metadatas\",\n      \"properties\": {\n        \"dtype\": \"object\",\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    }\n  ]\n}"}},"metadata":{}},{"output_type":"stream","name":"stdout","text":["\u001b[1m\u001b[36mAgent : \u001b[0m\n","\n","### Response:\n","#### Policy Coverage details for Accidents Involving Public Transport:\n","\n","Based on the search results provided in the documents indexed, the relevant policy information can be found in the **Principal-Sample-Life-Insurance-Policy** document on page 55, page 54, and page 57. Below are the extracted details related to accidents involving public transport from the respective pages:\n","\n","1. **Loss Due to Accidental Bodily Injury:**\n","   - If a member incurs a loss within 365 days as a result of exposure due to accidental bodily injury, covered by the group policy, the benefit will be provided. (*Principal-Sample-Life-Insurance-Policy*, Page 55)\n","\n","2. **Seat Belt/Airbag Benefit for Accidental Injuries in Automobiles:**\n","   - An additional benefit of $10,000 will be paid if a member loses their life in an automobile accident while using a factory-installed seat belt or proper airbag. (*Principal-Sample-Life-Insurance-Policy*, Page 55)\n","\n","3. **Benefits Payable for Losses:**\n","   - Depending on the type of loss incurred from an accident, different percentages of scheduled benefits may be paid out. Payment for loss of life will be made to the beneficiary. (*Principal-Sample-Life-Insurance-Policy*, Page 54)\n","\n","4. **Repatriation Benefit:**\n","   - If a member loses their life at least 100 miles away from their permanent residence, expenses for preparation and transportation of the body will be covered up to a maximum benefit of $2,000. (*Principal-Sample-Life-Insurance-Policy*, Page 57)\n","\n","5. **Educational Benefit:**\n","   - If a member loses their life, an additional $3,000 educational benefit will be paid annually for up to four years to each qualified student enrolled in a post-secondary school. (*Principal-Sample-Life-Insurance-Policy*, Page 57)\n","\n","\n","#### Table Format for the Policy Coverage Details:\n","\n","| Policy Information           | Page Number | Policy Name                          |\n","|------------------------------|-------------|--------------------------------------|\n","| Loss Due to Accidental Injury | 55          | Principal-Sample-Life-Insurance-Policy |\n","| Seat Belt/Airbag Benefit      | 55          | Principal-Sample-Life-Insurance-Policy |\n","| Benefits Payable for Losses   | 54          | Principal-Sample-Life-Insurance-Policy |\n","| Repatriation Benefit           | 57         | Principal-Sample-Life-Insurance-Policy |\n","| Educational Benefit           | 57         | Principal-Sample-Life-Insurance-Policy |\n","\n","For more detailed information, please refer to the sections mentioned within the cited policy document on the respective pages provided above.\n","\n","Feel free to explore these sections for a comprehensive understanding of the policy coverage details related to accidents involving public transport.\n","\n","What else is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","Exit\n","\n","Error: Runtime no longer has a reference to this dataframe, please re-run this cell and try again.\n"]}]},{"cell_type":"code","source":["run_rag(debug=False)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Jwr_oRRUqOEs","executionInfo":{"status":"ok","timestamp":1718620491069,"user_tz":-330,"elapsed":31201,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"4d191c6f-59da-4299-8a13-0d8b7c031ec3"},"execution_count":113,"outputs":[{"output_type":"stream","name":"stdout","text":["The converation with the policy starts now, type \u001b[1m'Exit'\u001b[0m to \u001b[1mstop\u001b[0m \n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","What is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","What are the policy coverage details for accidents involving public transport?\n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","\n","### Response:\n","Based on the search results, I found relevant information from the policy named 'Principal-Sample-Life-Insurance-Policy' on pages 55, 54, and 57 that may address the policy coverage details for accidents involving public transport.\n","\n","#### Policy Coverage Details for Accidents Involving Public Transport:\n","\n","1. **Seat Belt/Airbag Benefit:**\n","   - If a member loses their life due to an accidental injury sustained while driving or riding in an automobile, an additional benefit of $10,000 will be paid to the beneficiary named for member life insurance.\n","   - Conditions:\n","     - The automobile must be equipped with factory-installed seat belts.\n","     - The seat belt must have been in actual use by the member and properly fastened at the time of the accident.\n","     - The position of the seat belt must be certified in the official accident report.\n","     - The benefit also applies to accidents involving a functional driver-side or passenger-side airbag.\n","     - The deployment of the airbag must be certified in the official report of the accident.\n","   - Citation: 'Principal-Sample-Life-Insurance-Policy', Page 55\n","\n","2. **Benefits Payable for Loss of Life and Dismemberment:**\n","   - The policy specifies different percentages of scheduled benefits payable for various types of losses resulting from accidents, including loss of life, hands, feet, and senses like sight, speech, or hearing.\n","   - Eligibility and claim requirements are detailed.\n","   - In case of disappearance due to an accidental wrecking or sinking with specific conditions met, the policy covers the injury results.\n","   - Citation: 'Principal-Sample-Life-Insurance-Policy', Page 54\n","\n","3. **Repatriation and Educational Benefits:**\n","   - If a member loses their life at least 100 miles away from their residence, the policy covers expenses for body preparation and transportation for burial.\n","   - In addition, an educational benefit of $3,000 annually for up to four years is provided to qualified students if a member's life is lost.\n","   - Citation: 'Principal-Sample-Life-Insurance-Policy', Page 57\n","\n","For further details and specific coverage scenarios related to accidents involving public transport, please refer to the respective policy sections mentioned above in the 'Principal-Sample-Life-Insurance-Policy  and cross-reference the cited page numbers (55, 54, 57) for more comprehensive information. \n","\n","What else is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","Exit\n","\n"]}]},{"cell_type":"markdown","source":["#### Question 2 :"],"metadata":{"id":"gy9mEX--rgW9"}},{"cell_type":"code","source":["run_rag(debug=True)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":1224},"executionInfo":{"status":"ok","timestamp":1718620821101,"user_tz":-330,"elapsed":18110,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"a1d4251a-f279-43ad-c2d9-eb4b521cc019","id":"35m-gd_Sx7fn"},"execution_count":114,"outputs":[{"output_type":"stream","name":"stdout","text":["The converation with the policy starts now, type \u001b[1m'Exit'\u001b[0m to \u001b[1mstop\u001b[0m \n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","What is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","How does the policy address claims related to natural disasters?\n","\n"]},{"output_type":"display_data","data":{"text/plain":["                                           Documents  \\\n","0  f . claim requirements listed in part iv, sect...   \n","1  section d - claim procedures article 1 - notic...   \n","2  exposure exposure to the elements will be pres...   \n","\n","                                           Metadatas  \n","0  {'Page_No.': '54', 'Policy_Name': 'Principal-S...  \n","1  {'Page_No.': '61', 'Policy_Name': 'Principal-S...  \n","2  {'Page_No.': '55', 'Policy_Name': 'Principal-S...  "],"text/html":["\n","  <div id=\"df-e31561c9-5065-4e24-9b18-efb063472307\" class=\"colab-df-container\">\n","    <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Documents</th>\n","      <th>Metadatas</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>f . claim requirements listed in part iv, sect...</td>\n","      <td>{'Page_No.': '54', 'Policy_Name': 'Principal-S...</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>section d - claim procedures article 1 - notic...</td>\n","      <td>{'Page_No.': '61', 'Policy_Name': 'Principal-S...</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>exposure exposure to the elements will be pres...</td>\n","      <td>{'Page_No.': '55', 'Policy_Name': 'Principal-S...</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","    <div class=\"colab-df-buttons\">\n","\n","  <div class=\"colab-df-container\">\n","    <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-e31561c9-5065-4e24-9b18-efb063472307')\"\n","            title=\"Convert this dataframe to an interactive table.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\" viewBox=\"0 -960 960 960\">\n","    <path d=\"M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z\"/>\n","  </svg>\n","    </button>\n","\n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    .colab-df-buttons div {\n","      margin-bottom: 4px;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","    <script>\n","      const buttonEl =\n","        document.querySelector('#df-e31561c9-5065-4e24-9b18-efb063472307 button.colab-df-convert');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      async function convertToInteractive(key) {\n","        const element = document.querySelector('#df-e31561c9-5065-4e24-9b18-efb063472307');\n","        const dataTable =\n","          await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                    [key], {});\n","        if (!dataTable) return;\n","\n","        const docLinkHtml = 'Like what you see? Visit the ' +\n","          '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","          + ' to learn more about interactive tables.';\n","        element.innerHTML = '';\n","        dataTable['output_type'] = 'display_data';\n","        await google.colab.output.renderOutput(dataTable, element);\n","        const docLink = document.createElement('div');\n","        docLink.innerHTML = docLinkHtml;\n","        element.appendChild(docLink);\n","      }\n","    </script>\n","  </div>\n","\n","\n","<div id=\"df-c783b412-c998-4bcd-961a-13cd24f5b5fb\">\n","  <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-c783b412-c998-4bcd-961a-13cd24f5b5fb')\"\n","            title=\"Suggest charts\"\n","            style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","  </button>\n","\n","<style>\n","  .colab-df-quickchart {\n","      --bg-color: #E8F0FE;\n","      --fill-color: #1967D2;\n","      --hover-bg-color: #E2EBFA;\n","      --hover-fill-color: #174EA6;\n","      --disabled-fill-color: #AAA;\n","      --disabled-bg-color: #DDD;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","      --bg-color: #3B4455;\n","      --fill-color: #D2E3FC;\n","      --hover-bg-color: #434B5C;\n","      --hover-fill-color: #FFFFFF;\n","      --disabled-bg-color: #3B4455;\n","      --disabled-fill-color: #666;\n","  }\n","\n","  .colab-df-quickchart {\n","    background-color: var(--bg-color);\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: var(--fill-color);\n","    height: 32px;\n","    padding: 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: var(--hover-bg-color);\n","    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: var(--button-hover-fill-color);\n","  }\n","\n","  .colab-df-quickchart-complete:disabled,\n","  .colab-df-quickchart-complete:disabled:hover {\n","    background-color: var(--disabled-bg-color);\n","    fill: var(--disabled-fill-color);\n","    box-shadow: none;\n","  }\n","\n","  .colab-df-spinner {\n","    border: 2px solid var(--fill-color);\n","    border-color: transparent;\n","    border-bottom-color: var(--fill-color);\n","    animation:\n","      spin 1s steps(1) infinite;\n","  }\n","\n","  @keyframes spin {\n","    0% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","      border-left-color: var(--fill-color);\n","    }\n","    20% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    30% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","      border-right-color: var(--fill-color);\n","    }\n","    40% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    60% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","    }\n","    80% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-bottom-color: var(--fill-color);\n","    }\n","    90% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","    }\n","  }\n","</style>\n","\n","  <script>\n","    async function quickchart(key) {\n","      const quickchartButtonEl =\n","        document.querySelector('#' + key + ' button');\n","      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.\n","      quickchartButtonEl.classList.add('colab-df-spinner');\n","      try {\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      } catch (error) {\n","        console.error('Error during call to suggestCharts:', error);\n","      }\n","      quickchartButtonEl.classList.remove('colab-df-spinner');\n","      quickchartButtonEl.classList.add('colab-df-quickchart-complete');\n","    }\n","    (() => {\n","      let quickchartButtonEl =\n","        document.querySelector('#df-c783b412-c998-4bcd-961a-13cd24f5b5fb button');\n","      quickchartButtonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","    })();\n","  </script>\n","</div>\n","\n","    </div>\n","  </div>\n"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"dataframe","summary":"{\n  \"name\": \"run_rag(debug=True)\",\n  \"rows\": 3,\n  \"fields\": [\n    {\n      \"column\": \"Documents\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 3,\n        \"samples\": [\n          \"f . claim requirements listed in part iv, section d, must be satisfied; and g. all medical evidence must be satisfactory to the principal. article 3 - benefits payable if all of the benefit qualifications are met, the principal will pay: a. 100% of the scheduled benefit (or approved amount, if applicable) in force for loss of life; or b. 50% of the scheduled benefit (or approved amount, if applicable) in force if one hand is severed at or above the wrist; or c. 25% of the scheduled benefit (or approved amount, if applicable) in force for loss of thumb and index finger on the same hand; or d. 50% of the scheduled benefit (or approved amount, if applicable) in force if one foot is severed at or above the ankle; or e. 50% of the scheduled benefit (or approved amount, if applicable) in force if the sight of one eye is permanently lost (for this purpose, vision not correctable to better than 20/200 will be considered loss of sight.); or f. 100% of the scheduled benefit (or approved amount, if applicable) in force for more than one of the losses listed in b., d., or e. above. total payment for all losses under this article 3 that result from the same accident will not exceed the scheduled benefit (or approved amount, if applicable). payment for loss of life will be to the beneficiary named for member life insurance. payment will be subject to the beneficiary, facility of payment and settlement of proceeds provisions of part iv, section a. payment for all other losses will be to the member. disappearance it will be presumed that a member has lost his or her life if: a. the member's body has not been found within 365 days after the disappearance of a conveyance in which the member was an occupant at the time of disappearance; and b. the disappearance of the conveyance was due to its accidental wrecking or sinking; and c. this group policy would have covered the injury resulting from the accident. this policy has been updated effective january 1, 2014 part iv - benefits gc 6015 section b - member accidental death and dismemberment insurance,  2\",\n          \"section d - claim procedures article 1 - notice of claim written notice must be sent to the principal by or for a member or dependent who wishes to file claim for benefits under this group policy. this notice must be sent within 20 days after the date of the loss for which claim is being made. failure to give notice within the time specified will not invalidate or reduce any claim if notice is given as soon as reasonably possible. article 2 - claim forms the principal, when it receives notice of claim, will provide appropriate claim forms for filing proof of loss. if the forms are not provided within 15 days after the principal receives notice, the person will be considered to have complied with the requirements of this group policy upon submitting, within the time specified below for filing proof of loss, written proof covering the occurrence, character, and extent of the loss. article 3 - proof of loss written proof of loss must be sent to the principal within 90 days after the date of the loss. proof required includes the date, nature, and extent of the loss. the principal may request additional information to substantiate loss or require a signed unaltered authorization to obtain that information from the provider. failure to comply with the request of the principal could result in declination of the claim. for purposes of satisfying the claims processing timing requirements of the employee retirement income security act (erisa), receipt of claim will be considered to be met when the appropriate claim form is received by the principal. article 4 - payment, denial, and review erisa permits up to 45 days from receipt of claim for processing the claim. if a claim cannot be processed due to incomplete information, the principal will send a written explanation prior to the expiration of the 45 days. the claimant is then allowed up to 45 days to provide all additional information requested. the principal is permitted two 30-day extensions for processing an incomplete claim. written notification will be sent to the claimant regarding the extension. in actual practice, benefits under this group policy will be payable sooner, provided the principal receives complete and proper proof of loss. further, if a claim is not payable or cannot be processed, the principal will submit a detailed explanation of the basis for its denial. this policy has been updated effective january 1, 2014 part iv - benefits gc 6018 section d - claim procedures,  1\",\n          \"exposure exposure to the elements will be presumed to be an injury if: a. such exposure is due to an accidental bodily injury; and b. within 365 days after the injury, the member incurs a loss that is the result of the exposure; and c. this group policy would have covered the injury resulting from the accident. article 4 - seat belt/airbag benefit if the member loses his or her life as a result of an accidental injury sustained while driving or riding in an automobile, an additional benefit of $10,000 will be paid to the beneficiary named for member life insurance, provided all benefit qualifications as described in article 2 are met and: a. the automobile is equipped with factory-installed seat belts; and b. the seat belt was in actual use by the member and properly fastened at the time of the accident; and c. the position of the seat belt is certified in the official report of the accident or by the investigating officer. this additional benefit payment will also apply if the member was driving an automobile equipped with a properly functioning driver-side air bag or riding as a passenger in an automobile equipped with a properly functioning passenger-side air bag, although the member's seat belt may not have been fastened at the time of the accident. the properly functioning and/or deployment of the air bag must be certified in the official report of the accident or by the investigating officer. for the purpose of this benefit, \\\"automobile\\\" means a four-wheel passenger vehicle, station wagon, pick-up truck, or van-type vehicle, but excludes recreational-type vehicles such as a \\\"dune-buggy\\\" or an \\\"all-terrain\\\" vehicle. the term \\\"seat belt\\\" means a factory-installed device that forms an occupant restraint and injury avoidance system. article 5 - loss of use or paralysis benefit this policy has been updated effective january 1, 2014 part iv - benefits gc 6015 section b - member accidental death and dismemberment insurance,  3\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Metadatas\",\n      \"properties\": {\n        \"dtype\": \"object\",\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    }\n  ]\n}"}},"metadata":{}},{"output_type":"stream","name":"stdout","text":["\u001b[1m\u001b[36mAgent : \u001b[0m\n","\n","### Response:\n","\n","Based on the search results, the policy that addresses claims related to natural disasters is the **Principal-Sample-Life-Insurance-Policy**.\n","\n","Here are the key excerpts from the policy related to claims and benefits concerning natural disasters:\n","\n","| Article/Section | Description |\n","|-----------------|---------------|\n","| Article 3 - Benefits Payable | - % of scheduled benefit for various losses <br> - Provisions for loss of life, severing of hands/feet, loss of sight, and multiple losses due to the same accident |\n","| Article 4 - Seat Belt/Airbag Benefit | - Additional benefit of $10,000 if a member loses their life in an automobile accident with specific conditions on seat belt and airbag usage |\n","\n","These details can be found on:\n","- Page 54 for the benefits payable section under **Principal-Sample-Life-Insurance-Policy**\n","- Page 55 for the exposure section under **Principal-Sample-Life-Insurance-Policy**\n","\n","For more detailed information and specific claim procedures regarding natural disasters, you can refer to the respective sections mentioned above.\n","\n","The documents provide insights into the benefits and procedures related to natural disaster claims as outlined in the Principal-Sample-Life-Insurance-Policy.\n","\n","What else is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","Exit\n","\n"]}]},{"cell_type":"code","source":["run_rag(debug=False)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1718621018520,"user_tz":-330,"elapsed":27039,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"4eff1b3d-bad9-4d2d-c6b7-41a98246a68d","id":"OW1gjeBQx7fz"},"execution_count":116,"outputs":[{"output_type":"stream","name":"stdout","text":["The converation with the policy starts now, type \u001b[1m'Exit'\u001b[0m to \u001b[1mstop\u001b[0m \n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","What is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","How does the policy address claims related to natural disasters?\n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","### Response:\n","\n","#### Policy: Principal-Sample-Life-Insurance-Policy\n","**Page No.: 54**\n","- The policy addresses claims related to natural disasters based on specific qualifications and benefits. \n","- If the loss is due to a natural disaster resulting in specific injuries, the principal will pay varying percentages of the scheduled benefit amount depending on the severity of the injury.\n","  \n","#### Explaining in Simple Terms:\n","When a natural disaster causes injuries as per terms in the policy from the Principal-Sample-Life-Insurance-Policy, the insurance becomes payable based on the degree of injury suffered. For example, if there is a loss of life or limb due to a natural disaster, the insurance will cover a percentage of the agreed benefit amount.\n","\n","| Type of Loss or Disappearance      | Benefit Covered                      |\n","|------------------------------------|--------------------------------------|\n","| Loss of life                       | 100% of scheduled benefit            |\n","| Severed hand above wrist          | 50% of scheduled benefit              |\n","| Loss of thumb and index finger    | 25% of scheduled benefit              |\n","| Severed foot above ankle          | 50% of scheduled benefit              |\n","| Permanent loss of sight in one eye | 50% of scheduled benefit             |\n","| Multiple specified losses          | 100% of scheduled benefit             |\n","\n","#### Search Guidance:\n","The detailed information can be found in the \"Principal-Sample-Life-Insurance-Policy\" starting from page 54 to understand the specifics around natural disaster-related claims coverages and associated benefits.\n","\n","---\n","\n","#### Note: \n","If you need more information or assistance regarding specific sections within the policy, please provide additional details for a targeted search.\n","\n","What else is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","Exit\n","\n"]}]},{"cell_type":"markdown","source":["#### Question 3 :"],"metadata":{"id":"FaZ3BjVK0GJQ"}},{"cell_type":"code","source":["run_rag(debug=True)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":1798},"executionInfo":{"status":"ok","timestamp":1718621517537,"user_tz":-330,"elapsed":174420,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"1bb4169a-184d-4580-ce39-486449744419","id":"fXRFexxA0GJX"},"execution_count":117,"outputs":[{"output_type":"stream","name":"stdout","text":["The converation with the policy starts now, type \u001b[1m'Exit'\u001b[0m to \u001b[1mstop\u001b[0m \n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","What is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","What benefits are available if the insured is permanently disabled in an accident?\n","\n"]},{"output_type":"display_data","data":{"text/plain":["                                           Documents  \\\n","1  payment of benefits will be subject to the ben...   \n","5  f . claim requirements listed in part iv, sect...   \n","2  exposure exposure to the elements will be pres...   \n","\n","                                           Metadatas  \n","1  {'Page_No.': '49', 'Policy_Name': 'Principal-S...  \n","5  {'Page_No.': '54', 'Policy_Name': 'Principal-S...  \n","2  {'Page_No.': '55', 'Policy_Name': 'Principal-S...  "],"text/html":["\n","  <div id=\"df-4e4101b7-d2ed-413a-996b-1362c5c1dd09\" class=\"colab-df-container\">\n","    <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Documents</th>\n","      <th>Metadatas</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>1</th>\n","      <td>payment of benefits will be subject to the ben...</td>\n","      <td>{'Page_No.': '49', 'Policy_Name': 'Principal-S...</td>\n","    </tr>\n","    <tr>\n","      <th>5</th>\n","      <td>f . claim requirements listed in part iv, sect...</td>\n","      <td>{'Page_No.': '54', 'Policy_Name': 'Principal-S...</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>exposure exposure to the elements will be pres...</td>\n","      <td>{'Page_No.': '55', 'Policy_Name': 'Principal-S...</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","    <div class=\"colab-df-buttons\">\n","\n","  <div class=\"colab-df-container\">\n","    <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-4e4101b7-d2ed-413a-996b-1362c5c1dd09')\"\n","            title=\"Convert this dataframe to an interactive table.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\" viewBox=\"0 -960 960 960\">\n","    <path d=\"M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z\"/>\n","  </svg>\n","    </button>\n","\n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    .colab-df-buttons div {\n","      margin-bottom: 4px;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","    <script>\n","      const buttonEl =\n","        document.querySelector('#df-4e4101b7-d2ed-413a-996b-1362c5c1dd09 button.colab-df-convert');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      async function convertToInteractive(key) {\n","        const element = document.querySelector('#df-4e4101b7-d2ed-413a-996b-1362c5c1dd09');\n","        const dataTable =\n","          await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                    [key], {});\n","        if (!dataTable) return;\n","\n","        const docLinkHtml = 'Like what you see? Visit the ' +\n","          '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","          + ' to learn more about interactive tables.';\n","        element.innerHTML = '';\n","        dataTable['output_type'] = 'display_data';\n","        await google.colab.output.renderOutput(dataTable, element);\n","        const docLink = document.createElement('div');\n","        docLink.innerHTML = docLinkHtml;\n","        element.appendChild(docLink);\n","      }\n","    </script>\n","  </div>\n","\n","\n","<div id=\"df-10331db4-6106-4031-8842-3220912593ca\">\n","  <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-10331db4-6106-4031-8842-3220912593ca')\"\n","            title=\"Suggest charts\"\n","            style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","  </button>\n","\n","<style>\n","  .colab-df-quickchart {\n","      --bg-color: #E8F0FE;\n","      --fill-color: #1967D2;\n","      --hover-bg-color: #E2EBFA;\n","      --hover-fill-color: #174EA6;\n","      --disabled-fill-color: #AAA;\n","      --disabled-bg-color: #DDD;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","      --bg-color: #3B4455;\n","      --fill-color: #D2E3FC;\n","      --hover-bg-color: #434B5C;\n","      --hover-fill-color: #FFFFFF;\n","      --disabled-bg-color: #3B4455;\n","      --disabled-fill-color: #666;\n","  }\n","\n","  .colab-df-quickchart {\n","    background-color: var(--bg-color);\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: var(--fill-color);\n","    height: 32px;\n","    padding: 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: var(--hover-bg-color);\n","    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: var(--button-hover-fill-color);\n","  }\n","\n","  .colab-df-quickchart-complete:disabled,\n","  .colab-df-quickchart-complete:disabled:hover {\n","    background-color: var(--disabled-bg-color);\n","    fill: var(--disabled-fill-color);\n","    box-shadow: none;\n","  }\n","\n","  .colab-df-spinner {\n","    border: 2px solid var(--fill-color);\n","    border-color: transparent;\n","    border-bottom-color: var(--fill-color);\n","    animation:\n","      spin 1s steps(1) infinite;\n","  }\n","\n","  @keyframes spin {\n","    0% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","      border-left-color: var(--fill-color);\n","    }\n","    20% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    30% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","      border-right-color: var(--fill-color);\n","    }\n","    40% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    60% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","    }\n","    80% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-bottom-color: var(--fill-color);\n","    }\n","    90% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","    }\n","  }\n","</style>\n","\n","  <script>\n","    async function quickchart(key) {\n","      const quickchartButtonEl =\n","        document.querySelector('#' + key + ' button');\n","      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.\n","      quickchartButtonEl.classList.add('colab-df-spinner');\n","      try {\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      } catch (error) {\n","        console.error('Error during call to suggestCharts:', error);\n","      }\n","      quickchartButtonEl.classList.remove('colab-df-spinner');\n","      quickchartButtonEl.classList.add('colab-df-quickchart-complete');\n","    }\n","    (() => {\n","      let quickchartButtonEl =\n","        document.querySelector('#df-10331db4-6106-4031-8842-3220912593ca button');\n","      quickchartButtonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","    })();\n","  </script>\n","</div>\n","\n","    </div>\n","  </div>\n"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"dataframe","summary":"{\n  \"name\": \"run_rag(debug=True)\",\n  \"rows\": 3,\n  \"fields\": [\n    {\n      \"column\": \"Documents\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 3,\n        \"samples\": [\n          \"payment of benefits will be subject to the beneficiary and facility of payment provisions of this part iv, section a. article 6 - member life insurance - coverage during disability a member may be eligible to continue his or her member life and member accidental death and dismemberment insurance and dependent life insurance coverage during the member's adl disability or total disability. a. coverage qualification to be qualified for coverage during disability, a member must: (1) become adl disabled or totally disabled while insured for member life insurance; and (2) become adl disabled or totally disabled prior to the attainment of age 60; and (3) remain adl disabled or totally disabled continuously; and (4) be under the regular care and attendance of a physician; and (5) send proof of adl disability or total disability to the principal when required; and (6) submit to medical examinations or evaluations when required; and (7) return to the principal, without claim, any individual policy issued under his or her individual purchase rights as described in part iii, section f, article 1. upon return of such policy, the principal will refund premiums paid, less dividends and less any outstanding policy loan balance. b. proof of adl disability or total disability written proof of adl disability or total disability must be sent to the principal within one year of the date adl disability or total disability begins. further proof that adl disability or total disability has not ended must be sent when the principal requires. after adl disability or total disability has continued for two years from the date the first proof is received, the principal may not ask for further proof more than once each year. if the member dies while adl disabled or totally disabled, final proof that adl disability or total disability continued to the date of death must be sent to the principal. if death occurs within one year of the start of adl disability or total disability, but before the principal has received first proof, then final proof must be sent within one year of the date adl disability or total disability began. c. medical examinations and evaluations this policy has been updated effective january 1, 2014 part iv - benefits gc 6013 section a - member life insurance,  4\",\n          \"f . claim requirements listed in part iv, section d, must be satisfied; and g. all medical evidence must be satisfactory to the principal. article 3 - benefits payable if all of the benefit qualifications are met, the principal will pay: a. 100% of the scheduled benefit (or approved amount, if applicable) in force for loss of life; or b. 50% of the scheduled benefit (or approved amount, if applicable) in force if one hand is severed at or above the wrist; or c. 25% of the scheduled benefit (or approved amount, if applicable) in force for loss of thumb and index finger on the same hand; or d. 50% of the scheduled benefit (or approved amount, if applicable) in force if one foot is severed at or above the ankle; or e. 50% of the scheduled benefit (or approved amount, if applicable) in force if the sight of one eye is permanently lost (for this purpose, vision not correctable to better than 20/200 will be considered loss of sight.); or f. 100% of the scheduled benefit (or approved amount, if applicable) in force for more than one of the losses listed in b., d., or e. above. total payment for all losses under this article 3 that result from the same accident will not exceed the scheduled benefit (or approved amount, if applicable). payment for loss of life will be to the beneficiary named for member life insurance. payment will be subject to the beneficiary, facility of payment and settlement of proceeds provisions of part iv, section a. payment for all other losses will be to the member. disappearance it will be presumed that a member has lost his or her life if: a. the member's body has not been found within 365 days after the disappearance of a conveyance in which the member was an occupant at the time of disappearance; and b. the disappearance of the conveyance was due to its accidental wrecking or sinking; and c. this group policy would have covered the injury resulting from the accident. this policy has been updated effective january 1, 2014 part iv - benefits gc 6015 section b - member accidental death and dismemberment insurance,  2\",\n          \"exposure exposure to the elements will be presumed to be an injury if: a. such exposure is due to an accidental bodily injury; and b. within 365 days after the injury, the member incurs a loss that is the result of the exposure; and c. this group policy would have covered the injury resulting from the accident. article 4 - seat belt/airbag benefit if the member loses his or her life as a result of an accidental injury sustained while driving or riding in an automobile, an additional benefit of $10,000 will be paid to the beneficiary named for member life insurance, provided all benefit qualifications as described in article 2 are met and: a. the automobile is equipped with factory-installed seat belts; and b. the seat belt was in actual use by the member and properly fastened at the time of the accident; and c. the position of the seat belt is certified in the official report of the accident or by the investigating officer. this additional benefit payment will also apply if the member was driving an automobile equipped with a properly functioning driver-side air bag or riding as a passenger in an automobile equipped with a properly functioning passenger-side air bag, although the member's seat belt may not have been fastened at the time of the accident. the properly functioning and/or deployment of the air bag must be certified in the official report of the accident or by the investigating officer. for the purpose of this benefit, \\\"automobile\\\" means a four-wheel passenger vehicle, station wagon, pick-up truck, or van-type vehicle, but excludes recreational-type vehicles such as a \\\"dune-buggy\\\" or an \\\"all-terrain\\\" vehicle. the term \\\"seat belt\\\" means a factory-installed device that forms an occupant restraint and injury avoidance system. article 5 - loss of use or paralysis benefit this policy has been updated effective january 1, 2014 part iv - benefits gc 6015 section b - member accidental death and dismemberment insurance,  3\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"Metadatas\",\n      \"properties\": {\n        \"dtype\": \"object\",\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    }\n  ]\n}"}},"metadata":{}},{"output_type":"stream","name":"stdout","text":["\u001b[1m\u001b[36mAgent : \u001b[0m\n","**User Query Breakdown:**\n","- Query: What benefits are available if the insured is permanently disabled in an accident?\n","- Key Elements: \n","    - Type of coverage available for permanent disability\n","    - Eligibility criteria for receiving benefits\n","    - Probable percentage or amount covered for different disability scenarios\n","\n","**Analysis of search_results:**\n","- Relevant document found:\n","    - Policy Name: Principal-Sample-Life-Insurance-Policy\n","    - Page No.: 49, 54, 55\n","\n","**Extracted Information from Principal-Sample-Life-Insurance-Policy:**\n","\n","1. **Benefit for Permanent Disability:**\n","    - **Policy**: Principal-Sample-Life-Insurance-Policy\n","    - **Page No.**: 49\n","    - **Excerpt**: Insured must qualify for coverage during disability by being ADL disabled prior to age 60, continuously disabled, under a physician's care, and providing necessary proof of disability. Additionally, written proof of ADL disability must be submitted within one year of its onset.\n","\n","2. **Benefits for Different Disability Scenarios:**\n","    - **Policy**: Principal-Sample-Life-Insurance-Policy\n","    - **Page No.**: 54\n","    - **Excerpt**:\n","        \n","        | Loss Scenario                                                 | Percentage of Scheduled Benefit                                              |\n","        |---------------------------------------------------------------|-----------------------------------------------------------------------------|\n","        | Loss of Life                                                   | 100%                                                                        |\n","        | Severed Hand above Wrist                                      | 50%                                                                         |\n","        | Loss of Thumb and Index Finger on the Same Hand               | 25%                                                                         |\n","        | Severed Foot above Ankle                                      | 50%                                                                         |\n","        | Permanently Lost Sight of One Eye                             | 50%                                                                         |\n","        | More than one of the listed losses (b., d., e.)               | 100%                                                                        |\n","\n","3. **Additional Benefits for Specific Circumstances**:\n","    - **Policy**: Principal-Sample-Life-Insurance-Policy\n","    - **Page No.**: 55\n","    - **Excerpt**:\n","        - Article 4 provides benefits for Adl functionality loss due to accidental injuries.\n","        - Article 5 grants a supplementary benefit of $10,000 for losses incurred in accidents where the member was using the seat belt properly in an automobile equipped with seat belts or airbags.\n","\n","**Response:**\n","In the Principal-Sample-Life-Insurance-Policy, the insured can receive varied benefits if permanently disabled in an accident:\n","- To qualify, the insured must fulfill specific criteria such as being ADL disabled prior to age 60 and continuously disabled.\n","- Benefits range from 25% to 100% of the scheduled benefit based on the type of disability.\n","- Additional benefits of $10,000 are available for specific circumstances involving automobile accidents and proper seat belt or airbag usage.\n","\n","Feel free to refer to Principal-Sample-Life-Insurance-Policy, specifically pages 49, 54, and 55, for detailed information on benefits for permanent disability and related scenarios.\n","\n","This summarizes the available information pertaining to the query. If further details are needed or other search aspects should be explored, please let me know for continued assistance.\n","\n","What else is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","Exit\n","\n","Error: Runtime no longer has a reference to this dataframe, please re-run this cell and try again.\n","Error: Runtime no longer has a reference to this dataframe, please re-run this cell and try again.\n"]}]},{"cell_type":"code","source":["run_rag(debug=False)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1718621018520,"user_tz":-330,"elapsed":27039,"user":{"displayName":"Samriddh Lakhmani","userId":"02521612938973610721"}},"outputId":"4eff1b3d-bad9-4d2d-c6b7-41a98246a68d","id":"QXOGvjaQ0GJX"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["The converation with the policy starts now, type \u001b[1m'Exit'\u001b[0m to \u001b[1mstop\u001b[0m \n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","What is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","How does the policy address claims related to natural disasters?\n","\n","\u001b[1m\u001b[36mAgent : \u001b[0m\n","### Response:\n","\n","#### Policy: Principal-Sample-Life-Insurance-Policy\n","**Page No.: 54**\n","- The policy addresses claims related to natural disasters based on specific qualifications and benefits. \n","- If the loss is due to a natural disaster resulting in specific injuries, the principal will pay varying percentages of the scheduled benefit amount depending on the severity of the injury.\n","  \n","#### Explaining in Simple Terms:\n","When a natural disaster causes injuries as per terms in the policy from the Principal-Sample-Life-Insurance-Policy, the insurance becomes payable based on the degree of injury suffered. For example, if there is a loss of life or limb due to a natural disaster, the insurance will cover a percentage of the agreed benefit amount.\n","\n","| Type of Loss or Disappearance      | Benefit Covered                      |\n","|------------------------------------|--------------------------------------|\n","| Loss of life                       | 100% of scheduled benefit            |\n","| Severed hand above wrist          | 50% of scheduled benefit              |\n","| Loss of thumb and index finger    | 25% of scheduled benefit              |\n","| Severed foot above ankle          | 50% of scheduled benefit              |\n","| Permanent loss of sight in one eye | 50% of scheduled benefit             |\n","| Multiple specified losses          | 100% of scheduled benefit             |\n","\n","#### Search Guidance:\n","The detailed information can be found in the \"Principal-Sample-Life-Insurance-Policy\" starting from page 54 to understand the specifics around natural disaster-related claims coverages and associated benefits.\n","\n","---\n","\n","#### Note: \n","If you need more information or assistance regarding specific sections within the policy, please provide additional details for a targeted search.\n","\n","What else is muggling your brain?\n","\n","\u001b[1m\u001b[95mYou: \u001b[0m\n","Exit\n","\n"]}]},{"cell_type":"code","source":[],"metadata":{"id":"QGIlh0S80GJY"},"execution_count":null,"outputs":[]}],"metadata":{"colab":{"provenance":[{"file_id":"1WX78k9zJvMnm_E8BHJjEN0rNsHJzm4Yq","timestamp":1718527824559},{"file_id":"14FylZoU8--0-ekSKuRmE0HIezVTTUriA","timestamp":1694561966138}],"toc_visible":true,"collapsed_sections":["TvzJdaWI4rg3","spfTdDLG4-Py","hzuuEcUq_xag"]},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}